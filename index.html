<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>è±¡æ£‹åœå¦ - å®‰å®‰å®‡å®™ç«™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --red: #d32f2f;
      --black: #111;
      --bg: #fafafa;
      --card: #fff;
      --border: #e5e7eb;
      --accent: #2563eb;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      background: var(--bg);
      color: #111;
    }

    .wrap {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px 12px 28px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
    }

    .bar-actions {
      display: flex;
      gap: 8px;
    }

    .ghost {
      background: transparent;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 14px;
    }

    .ghost:active {
      opacity: .7;
    }

    .status {
      margin: 6px 0 10px;
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
      margin-top: 6px;
    }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      border: 2px dashed var(--border);
      border-radius: 9999px;
      background: #fff;
      aspect-ratio: 1/1;
      min-width: 72px;
      min-height: 72px;
      user-select: none;
      cursor: pointer;
      font-size: 28px;
      /* æ”¾å¤§æ£‹å­— */
    }

    .cell.red {
      color: var(--red);
    }

    .cell.black {
      color: var(--black);
    }

    .cell.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .12);
    }

    .poslabel {
      font-size: 12px;
      color: #999;
      margin-top: 2px;
    }

    .hint {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin: 8px 0 0;
    }

    .controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 12px 0 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 16px;
    }

    .btn-primary {
      background: #111;
      color: #fff;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #111;
      border: 1px solid var(--border);
    }

    .pieces {
      margin-top: 10px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .piece-btn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 12px 0;
      font-size: 18px;
      text-align: center;
    }

    .piece-btn:active {
      transform: scale(.98);
    }

    .piece-btn.red {
      color: var(--red);
    }

    .piece-btn.black {
      color: var(--black);
    }

    .footer-pad {
      height: 8px;
    }

    .ver-badge {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: #6b7280;
      background: #fff;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">è±¡æ£‹åœå¦-å–®å¦</div>
      <div class="bar-actions">
        <button class="ghost" id="askBtn">è¼¸å…¥å•é¡Œ</button>
        <button class="ghost" id="reloadBtn">Reload</button>
        <span class="ver-badge" id="ver">v1.0.12</span>
      </div>
    </div>

    <div id="status" class="status">åˆå§‹åŒ–ä¸­â€¦</div>

    <div class="card">
      <div id="cardTitle" class="card-title"></div>

      <!-- ä¹å®®æ ¼ï¼ˆä¸Šï¼š4 / ä¸­ï¼š2 1 3 / ä¸‹ï¼š5ï¼‰ -->
      <div class="grid" aria-label="åå­—ä¹å®®æ ¼">
        <div></div>
        <div class="cell" id="pos4"><span>ä½ç½®4</span>
          <div class="poslabel">â†‘ é»é¸ä»¥é–å®š</div>
        </div>
        <div></div>

        <div class="cell" id="pos2"><span>ä½ç½®2</span>
          <div class="poslabel">â†</div>
        </div>
        <div class="cell" id="pos1"><span>ä½ç½®1</span>
          <div class="poslabel">ä¸­å¿ƒ</div>
        </div>
        <div class="cell" id="pos3"><span>ä½ç½®3</span>
          <div class="poslabel">â†’</div>
        </div>

        <div></div>
        <div class="cell" id="pos5"><span>ä½ç½®5</span>
          <div class="poslabel">â†“</div>
        </div>
        <div></div>
      </div>

      <div class="controls">
        <button class="btn btn-secondary" id="randomBtn">éš¨æ©Ÿ</button>
        <button class="btn btn-primary" id="sendBtn">é€å‡º</button>
        <button class="btn btn-secondary" id="clearBtn">æ¸…é™¤</button>
      </div>

      <div class="hint">é»é¸ä¸‹æ–¹æ£‹å­ï¼Œç³»çµ±æœƒä¾åºæ”¾å…¥ï¼š1 â†’ 2 â†’ 3 â†’ 4 â†’ 5</div>
      <div class="hint">é»é¸ã€ŒæŒ‡å®šä½ç½®ã€â†’ å†é»ä¸‹æ–¹æ£‹å­</div>
    </div>

    <!-- æ£‹å­é¸æ“‡ï¼ˆé»‘åœ¨ä¸Šã€ç´…åœ¨ä¸‹ï¼‰ -->
    <div class="pieces">
      <div class="row" style="margin-bottom:8px">
        <!-- é»‘åœ‹ï¼šå°‡ å£« è±¡ è»Š é¦¬ åŒ… å’ -->
        <button class="piece-btn black" data-piece="å°‡">å°‡</button>
        <button class="piece-btn black" data-piece="å£«">å£«</button>
        <button class="piece-btn black" data-piece="è±¡">è±¡</button>
        <button class="piece-btn black" data-piece="è»Š">è»Š</button>
        <button class="piece-btn black" data-piece="é¦¬">é¦¬</button>
        <button class="piece-btn black" data-piece="åŒ…">åŒ…</button>
        <button class="piece-btn black" data-piece="å’">å’</button>
      </div>
      <div class="row">
        <!-- ç´…åœ‹ï¼šå¸¥ ä»• ç›¸ ä¿¥ å‚Œ ç‚® å…µ -->
        <button class="piece-btn red" data-piece="å¸¥">å¸¥</button>
        <button class="piece-btn red" data-piece="ä»•">ä»•</button>
        <button class="piece-btn red" data-piece="ç›¸">ç›¸</button>
        <button class="piece-btn red" data-piece="ä¿¥">ä¿¥</button>
        <button class="piece-btn red" data-piece="å‚Œ">å‚Œ</button>
        <button class="piece-btn red" data-piece="ç‚®">ç‚®</button>
        <button class="piece-btn red" data-piece="å…µ">å…µ</button>
      </div>
      <div class="footer-pad"></div>
    </div>
  </div>

  <script>
    /** ******************************
    *  ğŸ”§ åœ¨é€™è£¡æ›ä½ çš„ LIFF ID & ç‰ˆæœ¬
    *********************************/
    const LIFF_ID = "2007906926-NZW6EQ7P";
    const APP_VERSION = "v1.0.12";


    // ====== ç‹€æ…‹èˆ‡å·¥å…· ======
    const $ = (id) => document.getElementById(id);
    const posEls = { 1: $("pos1"), 2: $("pos2"), 3: $("pos3"), 4: $("pos4"), 5: $("pos5") };
    const statusEl = $("status");
    const titleEl = $("cardTitle");

    // ç›®å‰ 5 æ ¼å…§å®¹ï¼š{ type, color } æˆ– null
    const picks = { 1: null, 2: null, 3: null, 4: null, 5: null };
    let selectedPos = null; // å®šä½æ¨¡å¼ï¼šä½¿ç”¨è€…é¸çš„ç›®æ¨™ä½ç½®

    const RED_SET = new Set(["å¸¥", "ä»•", "ç›¸", "ä¿¥", "å‚Œ", "ç‚®", "å…µ"]);
    const BLACK_SET = new Set(["å°‡", "å£«", "è±¡", "è»Š", "é¦¬", "åŒ…", "å’"]);

    // æ•´å‰¯æ£‹ä¸Šé™
    const PIECE_LIMITS = {
      "å¸¥": 1, "ä»•": 2, "ç›¸": 2, "ä¿¥": 2, "å‚Œ": 2, "ç‚®": 2, "å…µ": 5,
      "å°‡": 1, "å£«": 2, "è±¡": 2, "è»Š": 2, "é¦¬": 2, "åŒ…": 2, "å’": 5
    };

    function pieceColorOf(type) {
      if (RED_SET.has(type)) return "red";
      if (BLACK_SET.has(type)) return "black";
      return null;
    }
    function firstEmptyPos() {
      for (let i = 1; i <= 5; i++) if (!picks[i]) return i;
      return null;
    }
    function countUsed(type) {
      let c = 0;
      for (let i = 1; i <= 5; i++) if (picks[i]?.type === type) c++;
      return c;
    }
    function canPlace(type, pos) {
      const limit = PIECE_LIMITS[type] ?? 0;
      const used = countUsed(type);
      const currentTypeAtPos = picks[pos]?.type || null;
      if (currentTypeAtPos === type) return true; // è¦†è“‹åŒç¨®ä¸å¢åŠ ç”¨é‡
      return used < limit;
    }

    function render() {
      for (let i = 1; i <= 5; i++) {
        const el = posEls[i];
        el.classList.remove("red", "black", "selected");
        if (picks[i]) {
          el.innerHTML = `<span>${picks[i].type}</span><div class="poslabel">ä½ç½®${i}</div>`;
          el.classList.add(picks[i].color === "red" ? "red" : "black");
        } else {
          const dir = i === 1 ? "ä¸­å¿ƒ" : i === 2 ? "â†" : i === 3 ? "â†’" : i === 4 ? "â†‘" : "â†“";
          el.innerHTML = `<span>ä½ç½®${i}</span><div class="poslabel">${dir}</div>`;
        }
        if (selectedPos === i) el.classList.add("selected");
      }
    }

    function setSelected(pos) {
      selectedPos = (selectedPos === pos ? null : pos);
      render();
    }

    function addPiece(type) {
      const color = pieceColorOf(type);
      if (!color) return;

      const pos = selectedPos || firstEmptyPos();
      if (!pos) { alert("å·²æ”¾æ»¿ 5 æ ¼ï¼›è‹¥è¦é‡é¸ï¼Œè«‹æŒ‰ã€Œæ¸…é™¤ã€ã€‚"); return; }

      if (!canPlace(type, pos)) {
        const remain = (PIECE_LIMITS[type] - countUsed(type));
        alert(`ã€Œ${type}ã€å¯ç”¨æ•¸é‡ä¸è¶³ï¼ˆå‰©é¤˜ ${Math.max(0, remain)}ï¼‰`);
        return;
      }

      picks[pos] = { type, color };
      const next = firstEmptyPos();
      selectedPos = next; // è‹¥æ»¿æ ¼æœƒæ˜¯ null
      render();
    }

    function clearAll() {
      for (let i = 1; i <= 5; i++) picks[i] = null;
      selectedPos = null;
      render();
    }

    function hardReload() {
      const base = location.origin + location.pathname;
      location.replace(base + "?t=" + Date.now()); // ç ´å¿«å–
    }

    function promptQuestion() {
      const t = prompt("è«‹è¼¸å…¥ä½ çš„åœå¦å•é¡Œï¼š", titleEl.textContent || "");
      if (t && t.trim()) titleEl.textContent = t.trim();
    }

    // ====== éš¨æ©Ÿ 5 é¡†ï¼ˆéµå®ˆæ¯ç¨®ä¸Šé™ï¼‰ ======
    function randomFill() {
      clearAll();
      // å»ºæ¬Šé‡æ± ï¼šæ¯ç¨®æ£‹ä¾ä¸Šé™é‡è¤‡æ”¾å…¥ï¼Œè®“å…µ/å’è¼ƒå¸¸è¢«æŠ½ä¸­
      const pool = [];
      Object.keys(PIECE_LIMITS).forEach(type => {
        for (let k = 0; k < PIECE_LIMITS[type]; k++) pool.push(type);
      });
      // éš¨æ©ŸæŠ½ 5 é¡†ï¼ŒæŠ½åˆ°ä¸åˆæ³•ï¼ˆè¶…ä¸Šé™ï¼‰å°±é‡æŠ½ä¸€æ¬¡
      let i = 0, guard = 0;
      while (i < 5 && guard < 100) {
        guard++;
        const type = pool[Math.floor(Math.random() * pool.length)];
        const pos = firstEmptyPos();
        if (!pos) break;
        if (canPlace(type, pos)) {
          picks[pos] = { type, color: pieceColorOf(type) };
          i++;
        }
      }
      selectedPos = firstEmptyPos();
      render();
    }

    // ====== Flex é€å‡º ======
    function buildFlexMessage() {
      const cells = [1, 2, 3, 4, 5].map(i => picks[i]);
      if (cells.some(x => !x)) { alert("è«‹å…ˆé¸æ»¿ 5 æ ¼å†é€å‡ºã€‚"); return null; }

      const toText = (cell) => ({
        type: "text",
        text: String(cell.type),
        weight: "bold",
        align: "center",
        size: "xl",
        color: cell.color === "red" ? "#d32f2f" : "#111111"
      });

      const t1 = toText(picks[4]);
      const t2 = toText(picks[2]);
      const t3 = toText(picks[1]);
      const t4 = toText(picks[3]);
      const t5 = toText(picks[5]);

      const summary = [1, 2, 3, 4, 5].map(i => `${i}:${picks[i].type}`).join("  ");
      const fiveStr = [1, 2, 3, 4, 5].map(i => picks[i].type).join(""); // äº”å­—
      const fiveParam = encodeURIComponent(fiveStr);
      const titleText = (titleEl.textContent || "è±¡æ£‹åœå¦-å–®æ›").trim();

      return {
        type: "flex",
        altText: `${summary}`,
        contents: {
          type: "bubble",
          body: {
            type: "box",
            layout: "vertical",
            spacing: "md",
            contents: [
              { type: "text", text: titleText, weight: "bold", size: "lg", wrap: true },
              { type: "box", layout: "horizontal", justifyContent: "center", contents: [t1] },
              { type: "box", layout: "horizontal", spacing: "md", contents: [t2, t3, t4] },
              { type: "box", layout: "horizontal", justifyContent: "center", contents: [t5] },
              { type: "separator", margin: "md" },
              { type: "text", text: summary, size: "sm", color: "#6b7280", wrap: true },
              { type: "text", text: titleText, size: "sm", color: "#6b7280", wrap: true }
            ]
          },
          footer: {
            type: "box",
            layout: "vertical",
            spacing: "md",
            contents: [
              { type: "text", text: "LIFF æäº¤", size: "xs", color: "#9ca3af", align: "end" },
              {
                type: "box", layout: "vertical", flex: 1, contents: [
                  {
                    type: "button", style: "primary",
                    action: { type: "postback", label: "è§£æ", data: `cmd=analyze&p=${fiveParam}` }
                  }
                ]
              },
              {
                type: "box", layout: "vertical", flex: 1, contents: [
                  {
                    type: "button", style: "primary",
                    action: { type: "postback", label: "ç™‚ç™’åˆ†æ•¸", data: `cmd=heal&p=${fiveParam}` }
                  }
                ]
              },
              {
                type: "box", layout: "vertical", flex: 1, contents: [
                  {
                    type: "button", style: "secondary",
                    action: { type: "uri", label: "å†ä¸€æ¬¡3", uri: `https://liff.line.me/${LIFF_ID}` }
                  }
                ]
              },
              { type: "text", text: APP_VERSION, size: "xs", color: "#9ca3af", align: "end" }
            ]
          }
        }
      };
    }

    async function sendResult() {
      const flex = buildFlexMessage();
      if (!flex) return;
      try {
        if (liff?.isInClient?.()) {
          await liff.sendMessages([flex]);
          alert("å·²é€å‡ºï¼Œè¿”å›èŠå¤©å®¤"); liff.closeWindow();
        } else if (liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å·²åˆ†äº«");
        } else {
          alert("è«‹åœ¨ LINE å…§é–‹å•Ÿæ­¤ LIFF é é¢å†é€å‡ºã€‚");
        }
      } catch (e) {
        const msg = (e?.message || e || '').toString();
        if ((msg.includes('scope') || msg.includes('not in LIFF app scope')) && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å°šæœªæˆæ¬Š chat_message.writeï¼Œå·²æ”¹ç”¨åˆ†äº«é€å‡º");
        } else {
          alert("sendMessages å¤±æ•—ï¼š" + msg);
        }
      }
    }

    // ====== ç¶å®š UI ======
    $("askBtn").addEventListener("click", promptQuestion);
    $("reloadBtn").addEventListener("click", hardReload);
    $("clearBtn").addEventListener("click", clearAll);
    $("randomBtn").addEventListener("click", randomFill);
    $("sendBtn").addEventListener("click", sendResult);

    Object.entries(posEls).forEach(([idx, el]) => {
      el.addEventListener("click", () => setSelected(Number(idx)));
    });

    document.querySelectorAll(".piece-btn").forEach(btn => {
      btn.addEventListener("click", () => addPiece(btn.dataset.piece));
    });

    // ====== åˆå§‹åŒ– LIFF ======
    (async () => {
      try {
        statusEl.textContent = "åˆå§‹åŒ– LIFFâ€¦";
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        if (!liff.isLoggedIn()) { statusEl.textContent = "æœªç™»å…¥ â†’ å°å‘ç™»å…¥"; return liff.login(); }
        const profile = await liff.getProfile();
        statusEl.textContent = `Hello, ${profile.displayName} ğŸ‘‹`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = `LIFF åˆå§‹åŒ–å¤±æ•—ï¼š${err?.message || "unknown"}`;
      } 
    })();

    // ====== åˆå§‹ç‹€æ…‹èˆ‡ç‰ˆæœ¬é¡¯ç¤º ======
    document.getElementById("ver").textContent = APP_VERSION;

    // åˆæ¬¡æ¸²æŸ“
    render();
  </script>
</body>

</html>
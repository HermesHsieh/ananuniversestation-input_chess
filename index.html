<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>è±¡æ£‹åœå¦ - Anan Universe Station</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --red:#d32f2f; --black:#111; --bg:#fafafa; --card:#fff; --border:#e5e7eb; --accent:#2563eb;
    }
    body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif; background:var(--bg); color:#111;}
    .wrap{max-width:480px; margin:0 auto; padding:12px 12px 28px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .title{font-size:18px; font-weight:700;}
    .ghost{background:transparent; border:1px solid var(--border); padding:8px 10px; border-radius:10px; font-size:14px;}
    .ghost:active{opacity:.7;}
    .status{margin:6px 0 10px; font-size:12px; color:#666; text-align:center;}

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .grid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:6px;}
    .cell{padding:18px 8px; border:1px dashed var(--border); border-radius:12px; text-align:center; font-size:20px; min-height:56px; user-select:none; background:#fff; cursor:pointer;}
    .cell.red{color:var(--red);} .cell.black{color:var(--black);}
    .cell.selected{border:2px solid var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.12);}
    .poslabel{font-size:12px; color:#999; display:block; margin-top:4px;}
    .hint{font-size:12px; color:#666; text-align:center; margin:6px 0 0;}

    .controls{display:flex; gap:10px; justify-content:center; margin:12px 0 8px;}
    .btn{border:0; border-radius:12px; padding:12px 16px; font-size:16px;}
    .btn-primary{background:#111; color:#fff;}
    .btn-secondary{background:#f3f4f6; color:#111; border:1px solid var(--border);}

    .pieces{margin-top:10px;}
    .row{display:grid; grid-template-columns:repeat(7,1fr); gap:8px;}
    .piece-btn{border:1px solid var(--border); background:#fff; border-radius:12px; padding:12px 0; font-size:18px; text-align:center; }
    .piece-btn:active{transform:scale(.98);}
    .piece-btn.red{color:var(--red);} .piece-btn.black{color:var(--black);}
    .footer-pad{height:8px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">è±¡æ£‹åœå¦-å–®æ›è¼¸å…¥</div>
      <button class="ghost" id="reloadBtn">Reload</button>
    </div>

    <div id="status" class="status">åˆå§‹åŒ–ä¸­â€¦</div>

    <div class="card">
      <!-- ä¹å®®æ ¼ï¼ˆä¸Šï¼š4 / ä¸­ï¼š2 1 3 / ä¸‹ï¼š5ï¼‰ -->
      <div class="grid" aria-label="åå­—ä¹å®®æ ¼">
        <div></div>
        <div class="cell" id="pos4"><span>ä½ç½®4</span><span class="poslabel">â†‘ é»é¸ä»¥é–å®š</span></div>
        <div></div>

        <div class="cell" id="pos2"><span>ä½ç½®2</span><span class="poslabel">â†</span></div>
        <div class="cell" id="pos1"><span>ä½ç½®1</span><span class="poslabel">ä¸­å¿ƒ</span></div>
        <div class="cell" id="pos3"><span>ä½ç½®3</span><span class="poslabel">â†’</span></div>

        <div></div>
        <div class="cell" id="pos5"><span>ä½ç½®5</span><span class="poslabel">â†“</span></div>
        <div></div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" id="sendBtn">é€å‡º</button>
        <button class="btn btn-secondary" id="clearBtn">æ¸…é™¤</button>
      </div>

      <div class="hint">æ“ä½œæ–¹å¼ï¼šå…ˆé»ã€Œä¸Šæ–¹æŸå€‹ä½ç½®ã€â†’ å†é»ä¸‹æ–¹æ£‹å­ï¼›æœªé¸ä½ç½®æ™‚ï¼Œé è¨­ä¾åºå¡«å…¥ 1 â†’ 2 â†’ 3 â†’ 4 â†’ 5</div>
    </div>

    <!-- æ£‹å­é¸æ“‡ï¼ˆé»‘åœ¨ä¸Šã€ç´…åœ¨ä¸‹ï¼‰ -->
    <div class="pieces">
      <div class="row" style="margin-bottom:8px">
        <!-- é»‘åœ‹ï¼šå°‡ å£« è±¡ è»Š é¦¬ åŒ… å’ -->
        <button class="piece-btn black" data-piece="å°‡">å°‡</button>
        <button class="piece-btn black" data-piece="å£«">å£«</button>
        <button class="piece-btn black" data-piece="è±¡">è±¡</button>
        <button class="piece-btn black" data-piece="è»Š">è»Š</button>
        <button class="piece-btn black" data-piece="é¦¬">é¦¬</button>
        <button class="piece-btn black" data-piece="åŒ…">åŒ…</button>
        <button class="piece-btn black" data-piece="å’">å’</button>
      </div>
      <div class="row">
        <!-- ç´…åœ‹ï¼šå¸¥ ä»• ç›¸ ä¿¥ å‚Œ ç‚® å…µ -->
        <button class="piece-btn red" data-piece="å¸¥">å¸¥</button>
        <button class="piece-btn red" data-piece="ä»•">ä»•</button>
        <button class="piece-btn red" data-piece="ç›¸">ç›¸</button>
        <button class="piece-btn red" data-piece="ä¿¥">ä¿¥</button>
        <button class="piece-btn red" data-piece="å‚Œ">å‚Œ</button>
        <button class="piece-btn red" data-piece="ç‚®">ç‚®</button>
        <button class="piece-btn red" data-piece="å…µ">å…µ</button>
      </div>
      <div class="footer-pad"></div>
    </div>
  </div>

  <script>
    // â˜… æŠŠé€™è£¡æ›æˆä½ çš„ LIFF IDï¼ˆå®Œæ•´å­—ä¸²ï¼Œå¯å«é€£å­—è™Ÿå¾Œç¶´ï¼‰
    const LIFF_ID = "2007906926-NZW6EQ7P";

    // ====== ç‹€æ…‹ ======
    const $ = (id)=>document.getElementById(id);
    const posEls = {1:$("pos1"),2:$("pos2"),3:$("pos3"),4:$("pos4"),5:$("pos5")};
    const statusEl = $("status");

    // ç›®å‰ 5 æ ¼å…§å®¹ï¼š{ type, color } æˆ– null
    const picks = {1:null,2:null,3:null,4:null,5:null};
    let selectedPos = null; // å®šä½æ¨¡å¼ï¼šä½¿ç”¨è€…é¸å®šçš„ç›®æ¨™ä½ç½®

    const RED_SET   = new Set(["å¸¥","ä»•","ç›¸","ä¿¥","å‚Œ","ç‚®","å…µ"]);
    const BLACK_SET = new Set(["å°‡","å£«","è±¡","è»Š","é¦¬","åŒ…","å’"]);

    // æ¯å€‹æ£‹ç¨®çš„åˆæ³•æ•¸é‡ï¼ˆæ•´å‰¯æ£‹ï¼‰
    const PIECE_LIMITS = {
      "å¸¥":1,"ä»•":2,"ç›¸":2,"ä¿¥":2,"å‚Œ":2,"ç‚®":2,"å…µ":5,
      "å°‡":1,"å£«":2,"è±¡":2,"è»Š":2,"é¦¬":2,"åŒ…":2,"å’":5
    };

    function pieceColorOf(type){
      if(RED_SET.has(type)) return "red";
      if(BLACK_SET.has(type)) return "black";
      return null;
    }
    function firstEmptyPos(){
      for(let i=1;i<=5;i++) if(!picks[i]) return i;
      return null;
    }
    function countUsed(type){
      let c=0;
      for(let i=1;i<=5;i++) if(picks[i]?.type===type) c++;
      return c;
    }
    function canPlace(type, pos){
      const limit = PIECE_LIMITS[type] ?? 0;
      const used = countUsed(type);
      const currentTypeAtPos = picks[pos]?.type || null;
      // è‹¥åŸæœ¬æ ¼å­å°±æ˜¯åŒç¨®æ£‹ï¼Œå…è¨±è¦†è“‹ï¼ˆä¸å¢åŠ ä½¿ç”¨é‡ï¼‰
      if(currentTypeAtPos === type) return true;
      return used < limit;
    }

    function render(){
      for(let i=1;i<=5;i++){
        const el = posEls[i];
        el.classList.remove("red","black","selected");
        if(picks[i]){
          el.innerHTML = `<span>${picks[i].type}</span><span class="poslabel">ä½ç½®${i}</span>`;
          el.classList.add(picks[i].color==="red"?"red":"black");
        }else{
          const dir = i===1?"ä¸­å¿ƒ": i===2?"â†": i===3?"â†’": i===4?"â†‘":"â†“";
          el.innerHTML = `<span>ä½ç½®${i}</span><span class="poslabel">${dir}</span>`;
        }
        if(selectedPos===i) el.classList.add("selected");
      }
    }

    function setSelected(pos){
      if(selectedPos===pos){ selectedPos=null; }
      else { selectedPos=pos; }
      render();
    }

    function addPiece(type){
      const color = pieceColorOf(type);
      if(!color) return;

      // ç›®æ¨™ä½ç½®ï¼šå„ªå…ˆç”¨å®šä½æ¨¡å¼ï¼Œå¦å‰‡æ‰¾ç¬¬ä¸€å€‹ç©ºä½
      const pos = selectedPos || firstEmptyPos();
      if(!pos){
        alert("å·²æ”¾æ»¿ 5 æ ¼ï¼›è‹¥è¦é‡æ–°é¸ï¼Œè«‹æŒ‰ã€Œæ¸…é™¤ã€ã€‚");
        return;
      }

      // åˆæ³•æ£‹æ•¸é©—è­‰
      if(!canPlace(type, pos)){
        const remain = (PIECE_LIMITS[type] - countUsed(type));
        alert(`ã€Œ${type}ã€å¯ç”¨æ•¸é‡ä¸è¶³ï¼ˆå‰©é¤˜ ${Math.max(0,remain)}ï¼‰`);
        return;
      }

      picks[pos] = { type, color };
      // æ”¾å®Œå¾Œï¼Œè‡ªå‹•å°‡é¸å–ç§»åˆ°ä¸‹ä¸€å€‹ç©ºä½ï¼ˆè‹¥é‚„æœ‰ï¼‰
      const next = firstEmptyPos();
      selectedPos = next; // è‹¥å·²æ»¿ï¼Œæœƒæ˜¯ null
      render();
    }

    function clearAll(){
      for(let i=1;i<=5;i++) picks[i]=null;
      selectedPos=null;
      render();
    }

    function hardReload(){
      const base = location.origin + location.pathname;
      location.replace(base + "?t=" + Date.now()); // ç ´é™¤å¿«å–
    }

    // ====== Flex é€å‡º ======
    function buildFlexMessage(){
      const cells = [1,2,3,4,5].map(i => picks[i]);
      // å¿…é ˆå…¨æ»¿æ‰å¯é€å‡º
      const incomplete = cells.some(x=>!x);
      if(incomplete){
        alert("è«‹å…ˆé¸æ»¿ 5 æ ¼å†é€å‡ºã€‚");
        return null;
      }

      // è½‰ç‚º Flex çš„ä¸‰è¡Œå¸ƒå±€ï¼ˆä¸Š 4 / ä¸­ 2 1 3 / ä¸‹ 5ï¼‰
      const toText = (cell, fallback)=>({
        type:"text",
        text: cell ? cell.type : fallback,
        weight:"bold",
        align:"center",
        size:"xl",
        color: cell ? (cell.color==="red" ? "#d32f2f" : "#111111") : "#9ca3af"
      });

      const t1 = toText(picks[4], "ï¼");
      const t2 = toText(picks[2], "ï¼");
      const t3 = toText(picks[1], "ï¼");
      const t4 = toText(picks[3], "ï¼");
      const t5 = toText(picks[5], "ï¼");

      const summary = [1,2,3,4,5].map(i=>`${i}:${picks[i].type}`).join("  ");

      return {
        type: "flex",
        altText: `æœ¬å±€ï¼š${summary}`,
        contents: {
          type: "bubble",
          body: {
            type: "box",
            layout: "vertical",
            spacing: "md",
            contents: [
              { type:"text", text:"äº”æ ¼é¸æ“‡", weight:"bold", size:"lg" },
              // ä¸Šï¼š4
              { type:"box", layout:"horizontal", justifyContent:"center", contents:[ t1 ]},
              // ä¸­ï¼š2 1 3
              { type:"box", layout:"horizontal", spacing:"md", contents:[ t2, t3, t4 ]},
              // ä¸‹ï¼š5
              { type:"box", layout:"horizontal", justifyContent:"center", contents:[ t5 ]},
              { type:"separator", margin:"md" },
              { type:"text", text: summary, size:"sm", color:"#6b7280", wrap:true }
            ]
          },
          footer: {
            type: "box",
            layout: "vertical",
            contents: [
              { type:"text", text:"LIFF æäº¤", size:"xs", color:"#9ca3af", align:"end" }
            ]
          }
        }
      };
    }

    async function sendResult(){
      const flex = buildFlexMessage();
      if(!flex) return;

      try{
        if(liff?.isInClient?.()){
          await liff.sendMessages([ flex ]);
          alert("å·²é€å‡ºï¼Œè¿”å›èŠå¤©å®¤");
          liff.closeWindow();
        }else{
          // ç€è¦½å™¨ç›´é–‹ï¼ˆé LINE å…§ï¼‰å°±é¡¯ç¤º JSON é è¦½
          alert("ï¼ˆé LINE å…§é–‹å•Ÿï¼‰é è¦½æ–‡å­—å·²é¡¯ç¤ºæ–¼ä¸»æ§å°");
          console.log("Flex message:", flex);
        }
      }catch(e){
        alert("sendMessages å¤±æ•—ï¼š" + (e?.message||e));
      }
    }

    // ====== ç¶å®š UI ======
    $("reloadBtn").addEventListener("click", hardReload);
    $("clearBtn").addEventListener("click", clearAll);
    $("sendBtn").addEventListener("click", sendResult);

    Object.entries(posEls).forEach(([idx,el])=>{
      el.addEventListener("click", ()=> setSelected(Number(idx)));
    });

    document.querySelectorAll(".piece-btn").forEach(btn=>{
      btn.addEventListener("click", ()=> addPiece(btn.dataset.piece));
    });

    // ====== åˆå§‹åŒ– LIFF ======
    (async ()=>{
      try{
        statusEl.textContent = "åˆå§‹åŒ– LIFFâ€¦";
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        if(!liff.isLoggedIn()){ statusEl.textContent="æœªç™»å…¥ â†’ å°å‘ç™»å…¥"; return liff.login(); }
        const profile = await liff.getProfile();
        statusEl.textContent = `Hello, ${profile.displayName} ğŸ‘‹  |  å®šä½æ¨¡å¼å·²å•Ÿç”¨`;
      }catch(err){
        console.error(err);
        statusEl.textContent = `LIFF åˆå§‹åŒ–å¤±æ•—ï¼š${err?.message||"unknown"}`;
      }
    })();

    // åˆæ¬¡æ¸²æŸ“
    render();
  </script>
</body>
</html>

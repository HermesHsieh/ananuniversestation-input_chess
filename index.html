<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>è±¡æ£‹åœå¦ - å®‰å®‰å®‡å®™ç«™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --red: #d32f2f;
      --black: #111;
      --bg: #F6F7FB;
      --card: #fff;
      --border: #e5e7eb;
      --accent: #2563eb;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      background: var(--bg);
      color: #111;
    }

    /* å®šç¾©éš±è—ç”¨çš„ CSS */
    .hidden {
      display: none !important;
    }

    .wrap {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px 12px 28px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
    }

    .bar-actions {
      display: flex;
      gap: 8px;
    }

    .ghost {
      background: transparent;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 14px;
    }

    .ghost:active {
      opacity: .7;
    }

    .status {
      margin: 6px 0 10px;
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
      margin-top: 6px;
    }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      border: 2px dashed var(--border);
      border-radius: 9999px;
      background: #fff;
      aspect-ratio: 1/1;
      min-width: 72px;
      min-height: 72px;
      user-select: none;
      cursor: pointer;
      font-size: 36px;
      /* æ”¾å¤§æ£‹å­— */
    }

    .cell.red {
      color: var(--red);
    }

    .cell.black {
      color: var(--black);
    }

    .cell.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .12);
    }

    .poslabel {
      font-size: 12px;
      color: #999;
      margin-top: 2px;
    }

    .hint {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin: 8px 0 0;
    }

    .hint-version {
      font-size: 8px;
      color: #666;
      text-align: center;
      margin: 8px 0 0;
    }

    .controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 12px 0 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 16px;
    }

    .btn-primary {
      background: #111;
      color: #fff;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #111;
      border: 1px solid var(--border);
    }

    .pieces {
      margin-top: 10px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .piece-btn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 12px 0;
      font-size: 18px;
      text-align: center;
    }

    .piece-btn:active {
      transform: scale(.98);
    }

    .piece-btn.red {
      color: var(--red);
    }

    .piece-btn.black {
      color: var(--black);
    }

    .footer-pad {
      height: 8px;
    }

    .ver-badge {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: #6b7280;
      background: #fff;
    }

    /* ===== é›™åœˆæ¨£å¼ï¼ˆå¤–åœˆ4px / é–“éš™2px / å…§åœˆ2pxï¼›åœˆè‰²ï¼å­—è‰²ï¼‰ ===== */
    .cell {
      position: relative;
    }

    .cell .ring {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: #111;
      padding: 4px;
    }

    .cell .ring .gap {
      width: 100%;
      height: 100%;
      border-radius: 999px;
      background: #fff;
      padding: 2px;
    }

    .cell .ring .gap .inner {
      width: 100%;
      height: 100%;
      border-radius: 999px;
      background: #111;
      padding: 2px;
    }

    .cell .face {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      background: #fff;
    }

    .cell .face .face-text {
      font-weight: 700;
      font-size: 36px;
      line-height: 1;
      color: #111;
    }

    /* é¡è‰²åŒåŒ–ï¼šå¤–åœˆ/å…§åœˆ/å­— åŒè‰² */
    .cell.red .ring,
    .cell.red .ring .gap .inner,
    .cell.red .face .face-text {
      background: #d32f2f;
      color: #d32f2f;
    }

    .cell.black .ring,
    .cell.black .ring .gap .inner,
    .cell.black .face .face-text {
      background: #111;
      color: #111;
    }

    /* åŸæœ¬çš„ dashed é‚Šæ¡†å¯ä»¥ä¿ç•™ï¼›è‹¥æƒ³éš±è—è«‹è§£é™¤ä¸‹ä¸€è¡Œè¨»è§£ï¼š */
    /* .cell{ border: none; } */

    /* ===== é•·è¼©æ¨¡å¼ï¼šæ›´å¤§æŒ‰éˆ•ã€å–®æ¬„ã€äº”æ ¼æ›´å¤§ä¸¦éš±è—å®šä½æç¤º ===== */
    body.mode-elder .grid {
      gap: 18px;
    }

    body.mode-elder .cell {
      min-width: 96px;
      min-height: 96px;
    }

    body.mode-elder .cell .face .face-text {
      font-size: 42px;
    }

    body.mode-elder .pieces .row {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    body.mode-elder .piece-btn {
      width: 100%;
      height: 60px;
      font-size: 26px;
      text-align: left;
      padding-left: 14px;
      border-width: 2px;
    }

    body.mode-elder .btn {
      padding: 14px 18px;
      font-size: 18px;
    }

    /* åœ¨ HTML ä¸Šçµ¦ class="hide-on-elder" çš„å…ƒç´ ï¼Œé•·è¼©æ¨¡å¼è‡ªå‹•éš±è— */
    .hide-on-elder {
      display: block;
    }

    body.mode-elder .hide-on-elder {
      display: none !important;
    }

    /* åˆ‡æ›éˆ•æ¨£å¼ */
    .mode-toggle {
      border: 1px solid var(--border);
      background: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">å–®å¦</div>
      <div class="bar-actions">
        <button class="ghost" id="debugBtn1">Btn1</button>
        <button class="ghost" id="debugBtn2">Btn2</button>
        <button class="ghost" id="debugBtn3">Btn3</button>
        <button class="ghost" id="askBtn">è¼¸å…¥å•é¡Œåç¨±</button>
        <button class="ghost" id="reloadBtn">Reload</button>
        <button class="mode-toggle" id="modeToggleBtn">é•·è¼©æ¨¡å¼</button>
      </div>
    </div>

    <div id="status" class="status">åˆå§‹åŒ–ä¸­â€¦</div>


    <div class="card">
      <div id="cardTitle" class="card-title"></div>

      <!-- ä¹å®®æ ¼ï¼ˆä¸Šï¼š4 / ä¸­ï¼š2 1 3 / ä¸‹ï¼š5ï¼‰ -->
      <div></div>
      <div class="cell" id="pos4">
        <div class="ring">
          <div class="gap">
            <div class="inner"></div>
          </div>
        </div>
        <div class="face"><span class="face-text">4</span></div>
        <div class="poslabel hide-on-elder">â†‘ é»é¸ä»¥é–å®š</div>
      </div>
      <div></div>

      <div class="cell" id="pos2">
        <div class="ring">
          <div class="gap">
            <div class="inner"></div>
          </div>
        </div>
        <div class="face"><span class="face-text">2</span></div>
        <div class="poslabel">â†</div>
      </div>
      <div class="cell" id="pos1">
        <div class="ring">
          <div class="gap">
            <div class="inner"></div>
          </div>
        </div>
        <div class="face"><span class="face-text">1</span></div>
        <div class="poslabel">ä¸­å¿ƒ</div>
      </div>
      <div class="cell" id="pos3">
        <div class="ring">
          <div class="gap">
            <div class="inner"></div>
          </div>
        </div>
        <div class="face"><span class="face-text">3</span></div>
        <div class="poslabel">â†’</div>
      </div>

      <div></div>
      <div class="cell" id="pos5">
        <div class="ring">
          <div class="gap">
            <div class="inner"></div>
          </div>
        </div>
        <div class="face"><span class="face-text">5</span></div>
        <div class="poslabel">â†“</div>
      </div>
      <div></div>


      <div class="controls">
        <button class="btn btn-secondary" id="randomBtn">éš¨æ©Ÿ</button>
        <button class="btn btn-primary" id="sendBtn">é€å‡º</button>
        <button class="btn btn-secondary" id="clearBtn">æ¸…é™¤</button>
      </div>

      <div class="hint" style="text-align: left;">é»é¸ä¸‹æ–¹æ£‹å­ï¼Œç³»çµ±æœƒä¾åºæ”¾å…¥ï¼š1 â†’ 2 â†’ 3 â†’ 4 â†’ 5</div>
      <div class="hint hide-on-elder" style="text-align: left;">é»é¸ã€ŒæŒ‡å®šä½ç½®ã€â†’ å†é»ä¸‹æ–¹æ£‹å­</div>
      <div class="hint-box" style="display: flex; justify-content: space-between; align-items: center;">
        <div id="draw-mode" class="hint-version" style="text-align: left;">
          è¼¸å…¥æ–¹å¼ï¼šæ‰‹å‹•
        </div>
        <div class="hint-version" id="ver" style="text-align: right;">
        </div>
      </div>

    </div>

    <!-- æ£‹å­é¸æ“‡ï¼ˆé»‘åœ¨ä¸Šã€ç´…åœ¨ä¸‹ï¼‰ -->
    <div class="pieces">
      <div class="row" style="margin-bottom:8px">
        <!-- é»‘åœ‹ï¼šå°‡ å£« è±¡ è»Š é¦¬ åŒ… å’ -->
        <button class="piece-btn black" data-piece="å°‡">å°‡</button>
        <button class="piece-btn black" data-piece="å£«">å£«</button>
        <button class="piece-btn black" data-piece="è±¡">è±¡</button>
        <button class="piece-btn black" data-piece="è»Š">è»Š</button>
        <button class="piece-btn black" data-piece="é¦¬">é¦¬</button>
        <button class="piece-btn black" data-piece="åŒ…">åŒ…</button>
        <button class="piece-btn black" data-piece="å’">å’</button>
      </div>
      <div class="row">
        <!-- ç´…åœ‹ï¼šå¸¥ ä»• ç›¸ ä¿¥ å‚Œ ç‚® å…µ -->
        <button class="piece-btn red" data-piece="å¸¥">å¸¥</button>
        <button class="piece-btn red" data-piece="ä»•">ä»•</button>
        <button class="piece-btn red" data-piece="ç›¸">ç›¸</button>
        <button class="piece-btn red" data-piece="ä¿¥">ä¿¥</button>
        <button class="piece-btn red" data-piece="å‚Œ">å‚Œ</button>
        <button class="piece-btn red" data-piece="ç‚®">ç‚®</button>
        <button class="piece-btn red" data-piece="å…µ">å…µ</button>
      </div>
      <div class="footer-pad"></div>
    </div>

    <div id="logOutput"
      style="white-space: pre-wrap; background:#f0f0f0; padding:10px; border:1px solid #ccc; height:150px; overflow-y:auto;">
    </div>

  </div>

  <script>
    /** ******************************
    *  ğŸ”§ åœ¨é€™è£¡æ›ä½ çš„ LIFF ID & ç‰ˆæœ¬
    *********************************/
   // Production: 2007906926-NZW6EQ7P
   // Dev: 2007931033-4D50LqwM
    const LIFF_ID = "2007931033-4D50LqwM"; 
    
    const APP_VERSION = "v1.0.2";
    const LINE_ID = "@968noswo"; // ä½ çš„å®˜æ–¹å¸³è™Ÿ IDï¼ˆ@ é–‹é ­ï¼‰

    /** ******************************
    *  ğŸ§° å…¨å¥— 32 æšç‰Œå †ï¼ˆæŠ½éå³ç§»é™¤ï¼‰
    *********************************/
    // ä»¥æ•´å‰¯æ£‹çš„æ•¸é‡å»ºç«‹å®Œæ•´ç‰Œå †
    const FULL_DECK_COUNTS = {
      "å¸¥": 1, "ä»•": 2, "ç›¸": 2, "ä¿¥": 2, "å‚Œ": 2, "ç‚®": 2, "å…µ": 5,
      "å°‡": 1, "å£«": 2, "è±¡": 2, "è»Š": 2, "é¦¬": 2, "åŒ…": 2, "å’": 5
    };
    // ä¾æ•¸é‡å±•é–‹æˆé™£åˆ—ï¼ˆ32 æšï¼‰
    function makeFullDeck() {
      const arr = [];
      Object.entries(FULL_DECK_COUNTS).forEach(([type, n]) => {
        for (let i = 0; i < n; i++) arr.push(type);
      });
      return arr;
    }
    // ç›®å‰ç‰Œå †ï¼ˆnull è¡¨ç¤ºå°šæœªå»ºç«‹æˆ–å·²é‡ç½®ï¼‰
    let deck = null;

    // éœ€æ±‚ï¼šç¬¬ä¸€æ¬¡æŒ‰ã€Œéš¨æ©Ÿã€æˆ–æ¸…ç©ºå¾Œæ‰å»ºç«‹ç‰Œå †
    function ensureDeck() {
      if (!deck || deck.length === 0) deck = makeFullDeck();
      return deck;
    }
    // å¾ç‰Œå †éš¨æ©ŸæŠ½ 1 æšï¼ˆæœƒç§»é™¤è©²æšï¼‰
    function drawFromDeck() {
      ensureDeck();
      if (deck.length === 0) return null;
      const idx = Math.floor(Math.random() * deck.length);
      const [picked] = deck.splice(idx, 1);
      return picked; // å›å‚³æ£‹ç¨®å­—å…ƒ
    }

    // è¼¸å…¥æ–¹å¼ï¼ˆæ‰‹å‹• / éš¨æ©Ÿï¼‰
    let drawMode = "æ‰‹å‹•"; // é è¨­æ‰‹å‹•
    function setDrawMode(mode) {
      drawMode = mode;
      const dm = document.getElementById("draw-mode");
      if (dm) dm.textContent = `è¼¸å…¥æ–¹å¼ï¼š${drawMode}`;
    }

    // ====== ç‹€æ…‹èˆ‡å·¥å…· ======
    const $ = (id) => document.getElementById(id);
    const posEls = { 1: $("pos1"), 2: $("pos2"), 3: $("pos3"), 4: $("pos4"), 5: $("pos5") };
    const statusEl = $("status");
    const titleEl = $("cardTitle");

    // ç›®å‰ 5 æ ¼å…§å®¹ï¼š{ type, color } æˆ– null
    const picks = { 1: null, 2: null, 3: null, 4: null, 5: null };
    let selectedPos = null; // å®šä½æ¨¡å¼ï¼šä½¿ç”¨è€…é¸çš„ç›®æ¨™ä½ç½®

    const RED_SET = new Set(["å¸¥", "ä»•", "ç›¸", "ä¿¥", "å‚Œ", "ç‚®", "å…µ"]);
    const BLACK_SET = new Set(["å°‡", "å£«", "è±¡", "è»Š", "é¦¬", "åŒ…", "å’"]);

    // æ•´å‰¯æ£‹ä¸Šé™
    const PIECE_LIMITS = {
      "å¸¥": 1, "ä»•": 2, "ç›¸": 2, "ä¿¥": 2, "å‚Œ": 2, "ç‚®": 2, "å…µ": 5,
      "å°‡": 1, "å£«": 2, "è±¡": 2, "è»Š": 2, "é¦¬": 2, "åŒ…": 2, "å’": 5
    };

    function pieceColorOf(type) {
      if (RED_SET.has(type)) return "red";
      if (BLACK_SET.has(type)) return "black";
      return null;
    }
    function firstEmptyPos() {
      for (let i = 1; i <= 5; i++) if (!picks[i]) return i;
      return null;
    }
    function countUsed(type) {
      let c = 0;
      for (let i = 1; i <= 5; i++) if (picks[i]?.type === type) c++;
      return c;
    }
    function canPlace(type, pos) {
      const limit = PIECE_LIMITS[type] ?? 0;
      const used = countUsed(type);
      const currentTypeAtPos = picks[pos]?.type || null;
      if (currentTypeAtPos === type) return true; // è¦†è“‹åŒç¨®ä¸å¢åŠ ç”¨é‡
      return used < limit;
    }

    function render() {
      for (let i = 1; i <= 5; i++) {
        const el = posEls[i];
        const faceText = el.querySelector('.face-text');
        const posLbl = el.querySelector('.poslabel');
        el.classList.remove("red", "black", "selected");

        if (picks[i]) {
          faceText.textContent = picks[i].type;
          el.classList.add(picks[i].color === "red" ? "red" : "black");
          if (posLbl) posLbl.textContent = i === 1 ? "ä¸­å¿ƒ" : (i === 2 ? "â†" : i === 3 ? "â†’" : i === 4 ? "â†‘" : "â†“");
        } else {
          faceText.textContent = String(i);
          if (posLbl) posLbl.textContent = i === 1 ? "ä¸­å¿ƒ" : (i === 2 ? "â†" : i === 3 ? "â†’" : i === 4 ? "â†‘" : "â†“");
        }

        if (selectedPos === i) el.classList.add("selected");
      }
    }

    function setSelected(pos) {
      if (document.body.classList.contains('mode-elder')) return; // é•·è¼©æ¨¡å¼ä¸é–å®š
      selectedPos = (selectedPos === pos ? null : pos);
      render();
    }

    function addPiece(type) {
      setDrawMode("æ‰‹å‹•"); // â† ä½¿ç”¨è€…é»åº•éƒ¨æ£‹å­è¦–ç‚ºæ‰‹å‹•
      const color = pieceColorOf(type);
      if (!color) return;

      const pos = selectedPos || firstEmptyPos();
      if (!pos) { alert("å·²æ”¾æ»¿ 5 æ ¼ï¼›è‹¥è¦é‡é¸ï¼Œè«‹æŒ‰ã€Œæ¸…é™¤ã€ã€‚"); return; }

      if (!canPlace(type, pos)) {
        const remain = (PIECE_LIMITS[type] - countUsed(type));
        alert(`ã€Œ${type}ã€å¯ç”¨æ•¸é‡ä¸è¶³ï¼ˆå‰©é¤˜ ${Math.max(0, remain)}ï¼‰`);
        return;
      }

      picks[pos] = { type, color };
      const next = firstEmptyPos();
      selectedPos = next; // è‹¥æ»¿æ ¼æœƒæ˜¯ null
      render();
    }

    function clearAll(resetMode = true, resetDeck = true) {
      for (let i = 1; i <= 5; i++) picks[i] = null;
      selectedPos = null;
      if (resetMode) setDrawMode("æ‰‹å‹•"); // æ¸…ç©ºå¾Œå›åˆ°æ‰‹å‹•ï¼ˆå¯é—œé–‰ï¼‰
      if (resetDeck) deck = null;        // â˜… æ¸…ç©ºæ™‚ä¹Ÿé‡ç½®ç‰Œå †ï¼ˆå›åˆ° 32 æšï¼‰
      render();
    }

    function hardReload() {
      const base = location.origin + location.pathname;
      location.replace(base + "?t=" + Date.now()); // ç ´å¿«å–
    }

    function promptQuestion() {
      const t = prompt("è«‹è¼¸å…¥ä½ çš„åœå¦å•é¡Œï¼š", titleEl.textContent || "");
      if (t && t.trim()) titleEl.textContent = t.trim();
    }

    // ====== éš¨æ©Ÿ 5 é¡†ï¼ˆéµå®ˆæ¯ç¨®ä¸Šé™ï¼‰ ======
    function randomFillAll() {
      // å…ˆæ¸…ç©ºäº”æ ¼ï¼†é‡ç½®ç‰Œå †ï¼ˆä¿ç•™ã€Œéš¨æ©Ÿã€æ¨¡å¼ï¼‰
      clearAll(false, true);
      setDrawMode("éš¨æ©Ÿ");

      // ç¢ºä¿æœ‰ 32 æšå®Œæ•´ç‰Œå †
      ensureDeck();

      const order = [1, 2, 3, 4, 5];
      for (const pos of order) {
        const type = drawFromDeck();
        if (!type) { alert("ç‰Œå †æ„å¤–ç‚ºç©ºï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚"); ensureDeck(); break; }
        // deck å·²ä¿è­‰æ•¸é‡ï¼Œç†è«–ä¸Šä¸æœƒè¶…ä¸Šé™ï¼›ä¿éšªæª¢æŸ¥å¯ä¿ç•™
        if (!canPlace(type, pos)) continue;
        picks[pos] = { type, color: pieceColorOf(type) };
      }

      selectedPos = null; // æŠ½æ»¿å¾Œå–æ¶ˆé–å®š
      render();
    }


    // ====== éš¨æ©ŸæŠ½ 1 æšï¼ˆè‹¥ 5 æ ¼å·²æ»¿å‰‡æç¤ºï¼‰ ======
    function randomDrawOne() {
      // è‹¥ 5 æ ¼å·²æ»¿ï¼Œç›´æ¥æç¤º
      const empty = firstEmptyPos();
      if (!empty) { alert("5 æ ¼å·²æ»¿ï¼Œè«‹å…ˆã€Œæ¸…é™¤ã€å†æŠ½ã€‚"); return; }

      // å®šä½æ¨¡å¼å„ªå…ˆï¼šè‹¥é–å®šçš„æ ¼ç‚ºç©ºï¼Œå°±æ”¾é‚£æ ¼ï¼›å¦å‰‡æ”¾æœ€å‰é¢ç©ºæ ¼
      const target = (selectedPos && !picks[selectedPos]) ? selectedPos : empty;

      // æŠ½ 1 æšï¼›è‹¥ç‰Œå †ç©ºäº†æœƒè‡ªå‹•é‡å»º
      setDrawMode("éš¨æ©Ÿ");
      const type = drawFromDeck();
      if (!type) { alert("ç‰Œå †å·²ç©ºï¼Œå·²é‡å»ºã€‚è«‹å†è©¦ä¸€æ¬¡ã€‚"); ensureDeck(); return; }

      // æ”¾åˆ°ç›®æ¨™æ ¼
      if (!canPlace(type, target)) {
        // ç†è«–ä¸Šä¸æœƒç™¼ç”Ÿï¼ˆå› ç‚º 5 æ ¼ä¸Šé™é å°æ–¼æ•´å‰¯æ£‹æ•¸ï¼‰ï¼Œä½†ä¿éšªè™•ç†ï¼š
        alert(`ã€Œ${type}ã€å·²è¶…å‡ºå¯ç”¨æ•¸é‡ï¼Œæ”¹æŠ½ä¸‹ä¸€æšã€‚`);
        return randomDrawOne(); // ç›´æ¥å†æŠ½ä¸€æš
      }
      picks[target] = { type, color: pieceColorOf(type) };

      // ä¸‹ä¸€å€‹é é¸ç›®æ¨™ = ä¸‹ä¸€å€‹ç©ºæ ¼ï¼ˆè‹¥å·²æ»¿å‰‡ nullï¼‰
      selectedPos = firstEmptyPos();
      render();
    }

    function buildImageMessage() {
      const cells = [1, 2, 3, 4, 5].map(i => picks[i]);
      if (cells.some(x => !x)) { alert("è«‹å…ˆé¸æ»¿ 5 æ ¼å†é€å‡ºã€‚"); return null; }

      const toText = (cell) => ({
        type: "text",
        text: String(cell.type),
        weight: "bold",
        align: "center",
        size: "xl",
        color: cell.color === "red" ? "#d32f2f" : "#111111"
      });

      const t1 = toText(picks[4]);
      const t2 = toText(picks[2]);
      const t3 = toText(picks[1]);
      const t4 = toText(picks[3]);
      const t5 = toText(picks[5]);

      const summary = [1, 2, 3, 4, 5].map(i => `${i}:${picks[i].type}`).join("  ");
      printLog("æŠ½å–çµæœï¼š" + summary);
      const fiveStr = [1, 2, 3, 4, 5].map(i => picks[i].type).join(""); // äº”å­—
      printLog("äº”å­—ï¼š" + fiveStr);
      const fiveParam = encodeURIComponent(fiveStr);
      printLog("äº”å­—åƒæ•¸ï¼š" + fiveParam);
      const titleText = (titleEl.textContent || "è±¡æ£‹åœå¦-å–®å¦").trim();
      printLog("åœå¦å•é¡Œï¼š" + titleText);
      const titleParam = encodeURIComponent(titleText);
      printLog("åœå¦å•é¡Œåƒæ•¸ï¼š" + titleParam);
      const modeTag = (drawMode === "éš¨æ©Ÿ" ? "éš¨æ©Ÿ" : "æ‰‹å‹•"); // è¦é¡¯ç¤ºçš„æ–‡å­—
      printLog("è¼¸å…¥æ–¹å¼ï¼š" + modeTag);
      const modeParam = encodeURIComponent(modeTag);
      printLog("è¼¸å…¥æ–¹å¼åƒæ•¸ï¼š" + modeParam);
      const modeHint = (drawMode === "éš¨æ©Ÿ" ? "*éš¨æ©ŸæŠ½å¦çµæœåƒ…ä¾›åƒè€ƒ*" : "");
      printLog("è¼¸å…¥æ–¹å¼æç¤ºï¼š" + modeHint);
      const auto = (drawMode === "éš¨æ©Ÿ") ? 1 : 0;
      printLog("æ˜¯å¦éš¨æ©Ÿç”¢ç”Ÿï¼š" + auto);

      return {
        type: 'image',
        originalContentUrl: `https://i.imgur.com/MwS42AE.png?p=5cg&c=${fiveStr}&n=${titleText}&at=${auto}&v=${APP_VERSION}`,
        previewImageUrl: `https://i.imgur.com/MwS42AE.png`
      };
    }

    async function sendResult() {
      const flex = buildImageMessage();
      if (!flex) return;
      try {
        if (liff?.isInClient?.()) {
          await liff.sendMessages([flex]);
          alert("å·²é€å‡ºï¼Œè¿”å›èŠå¤©å®¤");
          liff.closeWindow();
        } else if (liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å·²åˆ†äº«");
        } else {
          alert("è«‹åœ¨ LINE å…§é–‹å•Ÿæ­¤ LIFF é é¢å†é€å‡ºã€‚");
        }
      } catch (e) {
        const msg = (e?.message || e || '').toString();
        if ((msg.includes('scope') || msg.includes('not in LIFF app scope')) && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å°šæœªæˆæ¬Š chat_message.writeï¼Œå·²æ”¹ç”¨åˆ†äº«é€å‡º");
        } else {
          alert("sendMessages å¤±æ•—ï¼š" + msg);
        }
      }
    }

    async function clickBtnDebug1() {
      const flex = {
        "type": "flex",
        "altText": "æ¸¬è©¦ Flex Message",
        "contents": {
          "type": "bubble",
          "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "text",
                "text": "é€™æ˜¯æ¨™é¡Œæ–‡å­—",
                "weight": "bold",
                "size": "lg"
              }
            ]
          },
          "footer": {
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "button",
                "style": "primary",
                "action": {
                  "type": "postback",
                  "label": "action",
                  "displayText": "æŒ‰ä¸‹æŒ‰éˆ•",
                  "data": "action=buy&itemid=123"
                }
              }
            ]
          }
        }
      };
      printLog("sendResult flex: ", flex);
      if (!flex) return;
      try {
        if (liff?.isInClient?.()) {
          await liff.sendMessages([flex]);
          alert("å·²é€å‡ºï¼Œè¿”å›èŠå¤©å®¤");
          liff.closeWindow();
        } else if (liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å·²åˆ†äº«");
        } else {
          alert("è«‹åœ¨ LINE å…§é–‹å•Ÿæ­¤ LIFF é é¢å†é€å‡ºã€‚");
        }
      } catch (e) {
        const msg = (e?.message || e || '').toString();
        if ((msg.includes('scope') || msg.includes('not in LIFF app scope')) && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å°šæœªæˆæ¬Š chat_message.writeï¼Œå·²æ”¹ç”¨åˆ†äº«é€å‡º");
        } else {
          alert("sendMessages å¤±æ•—ï¼š" + msg);
        }
      }
    }

    async function clickBtnDebug2() {
      const flex = {
        type: "flex",
        altText: "æ¸¬è©¦ Flex Message",
        contents: {
          type: "bubble",
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "text",
                text: "é€™æ˜¯æ¨™é¡Œæ–‡å­—",
                weight: "bold",
                size: "lg"
              }
            ]
          },
          footer: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "button",
                style: "primary",
                action: {
                  type: "uri",
                  label: "åˆ†äº«æ­¤è¨Šæ¯",
                  uri: `https://liff.line.me/${LIFF_ID}?param1=value1&param2=value2` // è«‹æ›¿æ›æˆä½ çš„åˆ†äº«éˆçµ 
                }
              }
            ]
          }
        }
      };
      printLog("sendResult flex: ", flex);
      if (!flex) return;
      try {
        if (liff?.isInClient?.()) {
          await liff.sendMessages([flex]);
          alert("å·²é€å‡ºï¼Œè¿”å›èŠå¤©å®¤");
          liff.closeWindow();
        } else if (liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å·²åˆ†äº«");
        } else {
          alert("è«‹åœ¨ LINE å…§é–‹å•Ÿæ­¤ LIFF é é¢å†é€å‡ºã€‚");
        }
      } catch (e) {
        const msg = (e?.message || e || '').toString();
        if ((msg.includes('scope') || msg.includes('not in LIFF app scope')) && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å°šæœªæˆæ¬Š chat_message.writeï¼Œå·²æ”¹ç”¨åˆ†äº«é€å‡º");
        } else {
          alert("sendMessages å¤±æ•—ï¼š" + msg);
        }
      }
    }

    async function clickBtnDebug3() {
      if (!await isUserFriend()) {
        alert("è«‹å…ˆåŠ å…¥å¥½å‹æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼");
        // è½‰è·³è‡³åŠ å¥½å‹é é¢ (ä½ çš„å®˜æ–¹å¸³è™ŸåŠ å…¥é€£çµ)
        window.location.href = "https://line.me/R/ti/p/" + LINE_ID;
        return;
      }
      // const flex = buildFlexMessage();
      // printLog("sendResult flex: ", flex);
      const flex = buildImageMessage();
      printLog("sendResult flex: ", flex);
      if (!flex) return;
      try {
        if (liff?.isInClient?.()) {
          await liff.sendMessages([flex]);
          alert("å·²é€å‡ºï¼Œè¿”å›èŠå¤©å®¤");
          liff.closeWindow();
        } else if (liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å·²åˆ†äº«");
        } else {
          alert("è«‹åœ¨ LINE å…§é–‹å•Ÿæ­¤ LIFF é é¢å†é€å‡ºã€‚");
        }
      } catch (e) {
        const msg = (e?.message || e || '').toString();
        if ((msg.includes('scope') || msg.includes('not in LIFF app scope')) && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å°šæœªæˆæ¬Š chat_message.writeï¼Œå·²æ”¹ç”¨åˆ†äº«é€å‡º");
        } else {
          alert("sendMessages å¤±æ•—ï¼š" + msg);
        }
      }
    }

    // ====== LIFF åˆ¤æ–·æ˜¯å¦ç‚ºå¥½å‹ ======
    async function isUserFriend() {
      const friend = await liff.getFriendship();
      return friend.friendFlag; // true ä»£è¡¨æ˜¯å¥½å‹ï¼Œfalse ä»£è¡¨ä¸æ˜¯å¥½å‹
    }

    // ====== æ—¥èªŒè¼¸å‡º ======
    function printLog(message) {
      const logDiv = document.getElementById('logOutput');
      if (logDiv) {
        logDiv.textContent += message + "\n";
        logDiv.scrollTop = logDiv.scrollHeight;  // è‡ªå‹•æ²åˆ°åº•éƒ¨
      }
    }

    // è§£æç¶²å€åƒæ•¸å‡½å¼
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function getQueryParamFromShared() {
      try {
        // å–å¾—ç›®å‰ç€è¦½å™¨ç¶²å€çš„ search params
        const params = new URLSearchParams(window.location.search);

        // å–å¾— liff.stateï¼ˆç¶“ URL encodeï¼‰
        let stateParam = params.get('liff.state');

        if (stateParam) {
          // è§£ç¢¼åƒæ•¸
          stateParam = decodeURIComponent(stateParam);

          // stateParam æœƒæ˜¯é¡ä¼¼ /path?a=1&b=2 çš„URI è·¯å¾‘åŠæŸ¥è©¢å­—ä¸²
          // æˆ‘å€‘è¦æŠŠå®ƒè§£ææˆ key-value
          const url = new URL("http://example.com" + stateParam); // åŠ å…¥ domain æ–¹ä¾¿ç”¨ URL API è§£æ
          const searchParams = url.searchParams;

          // ç¯„ä¾‹ï¼šå–å¾—ç‰¹å®šåƒæ•¸
          const a = searchParams.get('a');
          const b = searchParams.get('b');

          printLog(`liff.state è§£ç¢¼åƒæ•¸:\nå®Œæ•´è·¯å¾‘: ${stateParam}\na = ${a}\nb = ${b}`);
        } else {
          printLog('æ²’æœ‰ liff.state åƒæ•¸');
        }
      } catch (error) {
        printLog('è§£æ liff.state åƒæ•¸å¤±æ•—:', error);
        printLog('åˆå§‹åŒ– LIFF å¤±æ•—');
      }
    }

    // æº–å‚™è¦é€çš„è¨Šæ¯ï¼Œä¾åƒæ•¸ä¸åŒæ±ºå®šå…§å®¹
    function prepareMessage(parameter) {
      if (parameter === 'manually') {
        return {
          type: 'text',
          text: 'æ”¶åˆ°åƒæ•¸ manullyï¼ŒåŸ·è¡Œç™‚ç™’åˆ†æ•¸æŒ‡ä»¤ï¼'
        };
      } else if (parameter === 'auto') {
        return {
          type: 'text',
          text: 'è‡ªå‹•æ¨¡å¼å•Ÿå‹•ä¸­...'
        };
      } else {
        return {
          type: 'text',
          text: 'æœªå¸¶åƒæ•¸æˆ–åƒæ•¸å…§å®¹æœªçŸ¥ã€‚'
        };
      }
    }

    async function validateFlexOnServerJSONP(flex) {
      return new Promise((resolve, reject) => {
        const url = "https://script.google.com/macros/s/AKfycbwpTCUmsM55eTsXPLpkR6qgSkr8L0KzHXf323pwBXrwvTQJ2A8L2K0XmJwhyFPYaZRwPQ/exec";
        const cb = "cb" + Date.now();
        window[cb] = (data) => { resolve(data); delete window[cb]; script.remove(); };
        const u = `${url}?callback=${cb}&message=${encodeURIComponent(JSON.stringify(flex))}`;
        const script = document.createElement("script");
        script.src = u;
        script.onerror = () => { reject(new Error("JSONP load error")); delete window[cb]; };
        document.body.appendChild(script);
      });
    }

    // ====== ç¶å®š UI ======
    $("askBtn").addEventListener("click", promptQuestion);
    $("reloadBtn").addEventListener("click", hardReload);
    $("clearBtn").addEventListener("click", clearAll);
    $("randomBtn").addEventListener("click", randomFillAll);
    $("sendBtn").addEventListener("click", sendResult);
    $("debugBtn1").addEventListener("click", clickBtnDebug1);
    $("debugBtn2").addEventListener("click", clickBtnDebug2);
    $("debugBtn3").addEventListener("click", clickBtnDebug3);

    Object.entries(posEls).forEach(([idx, el]) => {
      el.addEventListener("click", () => setSelected(Number(idx)));
    });

    document.querySelectorAll(".piece-btn").forEach(btn => {
      btn.addEventListener("click", () => addPiece(btn.dataset.piece));
    });


    // ====== åˆå§‹åŒ– LIFF ======
    (async () => {
      try {
        statusEl.textContent = "é é¢åˆå§‹åŒ–ä¸­â€¦";
        // åˆå§‹åŒ– LIFF é™„å¸¶è‡ªå‹•ç™»å…¥å¤–éƒ¨ç€è¦½å™¨ç”¨æˆ¶åŠŸèƒ½
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        printLog("é é¢åˆå§‹åŒ–æˆåŠŸ");

        // æª¢æŸ¥æ˜¯å¦ç™»å…¥ï¼Œæœªç™»å…¥å°å‘ç™»å…¥
        if (!liff.isLoggedIn()) {
          statusEl.textContent = "æœªç™»å…¥ â†’ å°å‘ç™»å…¥";
          await liff.login();  // å‘¼å«å¾Œæœƒè·³è½‰é é¢ï¼Œé€™é‚Šå¾Œé¢ç¨‹å¼ç¢¼ä¸æœƒç¹¼çºŒåŸ·è¡Œ
          return;
        }

        // ç™»å…¥æˆåŠŸï¼Œå–å¾—ä½¿ç”¨è€…è³‡è¨Š
        const profile = await liff.getProfile();
        printLog("ç”¨æˆ¶åç¨±ï¼š" + profile.displayName);
        statusEl.textContent = `Hello, ${profile.displayName} ğŸ‘‹`;

        // å–å¾—ç¶²å€åƒæ•¸ p
        const urlParams = new URLSearchParams(window.location.search);
        const parameter = urlParams.get('p');
        printLog("ç¶²å€åƒæ•¸ p: " + parameter);

        getQueryParamFromShared();

        // è‹¥æœ‰å¸¶åƒæ•¸ä¸”éç©ºï¼Œç™¼é€è¨Šæ¯ä¸¦é—œé–‰çª—å£
        if (parameter !== null && parameter !== '') {
          printLog("sendMessages p: " + parameter);
          try {
            await liff.sendMessages([{ type: 'text', text: `å•Ÿå‹•ç™‚ç™’åˆ†æ•¸æŒ‡ä»¤ ${parameter}` }]);
            printLog("è¨Šæ¯é€å‡ºæˆåŠŸï¼Œé—œé–‰è¦–çª—");
            liff.closeWindow();
          } catch (sendError) {
            printLog("sendMessages å¤±æ•—: " + sendError.message);
            alert("è¨Šæ¯é€å‡ºå¤±æ•—:" + sendError.message);
          }
        }

      } catch (err) {
        printLog("åˆå§‹åŒ–éŒ¯èª¤: " + (err?.message || err));
        statusEl.textContent = `LIFF åˆå§‹åŒ–å¤±æ•—ï¼š${err?.message || "unknown"}`;
      }
    })();

    /* ===== é•·è¼©æ¨¡å¼åˆ‡æ› ===== */
    const MODE_KEY = 'xq_ui_mode'; // 'elder' | 'normal'

    function applyElderMode(on) {
      document.body.classList.toggle('mode-elder', !!on);
      const btn = document.getElementById('modeToggleBtn');
      if (btn) btn.textContent = on ? 'é€²éšæ¨¡å¼' : 'é•·è¼©æ¨¡å¼';

      // é•·è¼©æ¨¡å¼ â†’ åƒ…å…è¨±ä¾åºå¡«å…¥ï¼Œé—œé–‰å®šä½ï¼ˆè‹¥æœ‰ï¼‰
      if (on) {
        selectedPos = null;   // å–æ¶ˆé–å®š
      }
      try { localStorage.setItem(MODE_KEY, on ? 'elder' : 'normal'); } catch (e) { }
    }

    function initElderMode() {
      const saved = (typeof localStorage !== 'undefined') ? localStorage.getItem(MODE_KEY) : null;
      applyElderMode(saved === 'elder');
      const btn = document.getElementById('modeToggleBtn');
      if (btn) btn.addEventListener('click', () => {
        const next = !document.body.classList.contains('mode-elder');
        applyElderMode(next);
      });
    }

    // ====== åˆå§‹ç‹€æ…‹èˆ‡ç‰ˆæœ¬é¡¯ç¤º ======
    document.getElementById("ver").textContent = LINE_ID + " | " + APP_VERSION;

    // éš±è—æ—¥èªŒè¼¸å‡ºå€åŸŸ
    document.getElementById("logOutput").classList.add("hidden");

    // éš±è—é™¤éŒ¯æŒ‰éˆ•
    document.getElementById("debugBtn1").classList.add("hidden");
    document.getElementById("debugBtn2").classList.add("hidden");
    document.getElementById("debugBtn3").classList.add("hidden");

    initElderMode();
    // åˆæ¬¡æ¸²æŸ“
    render();
  </script>
</body>

</html>
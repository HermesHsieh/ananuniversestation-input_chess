<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>è±¡æ£‹åœå¦ - å®‰å®‰å®‡å®™ç«™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
    data-cf-beacon='{"token": "50bd6af270b7443b8b555db9457b093f"}'></script>
  <!-- End Cloudflare Web Analytics -->

  <style>
    :root {
      --red: #d32f2f;
      --black: #111;
      --bg: #F6F7FB;
      --card: #fff;
      --border: #e5e7eb;
      --accent: #2563eb;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      background: var(--bg);
      color: #111;
    }

    /* å®šç¾©éš±è—ç”¨çš„ CSS */
    .hidden {
      display: none !important;
    }

    .wrap {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px 12px 28px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
    }

    .number {
      font-size: 18px;
    }

    .bar-actions {
      display: flex;
      gap: 8px;
    }

    .ghost {
      background: transparent;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 14px;
    }

    .ghost:active {
      opacity: .7;
    }

    .status {
      margin: 6px 0 10px;
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
      margin-top: 6px;
    }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      border: 4px dashed var(--border);
      border-radius: 9999px;
      background: #fff;
      aspect-ratio: 1/1;
      min-width: 72px;
      min-height: 72px;
      user-select: none;
      cursor: pointer;
      font-size: 36px;
      /* æ”¾å¤§æ£‹å­— */
    }

    .cell.red {
      color: var(--red);
    }

    .cell.black {
      color: var(--black);
    }

    .cell.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .12);
      background-color: rgba(255, 165, 0, 0.2);
      /* é€æ˜æ·¡è—è‰²èƒŒæ™¯ */
    }

    .poslabel {
      font-size: 20px;
      color: #999;
      margin-top: 2px;
    }

    .hint {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin: 8px 0 0;
    }

    .hint.large {
      font-size: 18px;
      /* æ”¾å¤§å­—é«” */
      color: #444;
      /* å¯é©åº¦èª¿æ·±è‰² */
      font-weight: 600;
      /* å¯åŠ ç²— */
    }

    .hint-version {
      font-size: 8px;
      color: #666;
      text-align: center;
      margin: 8px 0 0;
    }

    .hint-version.large {
      font-size: 14px;
      /* æ”¾å¤§ç‰ˆå­—é«”å¤§å°ï¼Œå¯ä»¥èª¿æ•´ */
      color: #444;
      /* å¯é¸èª¿æ·±è‰² */
      font-weight: 600;
      /* å¯é©åº¦åŠ ç²— */
    }

    .controls {
      display: flex;
      width: 100%;
      gap: 8px;
      justify-content: center;
      margin: 12px 0 8px;
      flex-wrap: wrap;
    }

    .controls button {
      flex: 1;
      /* ç­‰åˆ†å¯¬åº¦ */
      margin: 0 6px;
      /* å·¦å³å¤–è·ç¶­æŒé–“è· */
      max-width: none;
      /* ç§»é™¤åŸä¾†è¨­å®šçš„ max-width é™åˆ¶ */
      width: auto;
      /* ç§»é™¤ç¡¬ç·¨å¯«å¯¬åº¦ï¼Œä½¿ç”¨ flex è¦†è“‹ */
      box-sizing: border-box;
      /* è¨ˆå…¥å…§é‚Šè·å’Œé‚Šæ¡† */
    }

    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 16px;
    }

    .btn-primary {
      background: #111;
      color: #fff;
      width: 100px;
      height: 56px;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #111;
      border: 1px solid var(--border);
      width: 100px;
      height: 56px;
    }

    .pieces {
      margin-top: 10px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .piece-btn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 12px 0;
      font-size: 28px;
      text-align: center;
    }

    .piece-btn:active {
      transform: scale(.98);
    }

    .piece-btn.red {
      color: var(--red);
    }

    .piece-btn.black {
      color: var(--black);
    }

    .footer-pad {
      height: 8px;
    }

    .ver-badge {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: #6b7280;
      background: #fff;
    }

    /* ===== è€äººæ¨¡å¼ï¼šäº”å­æ”¹ä¸€åˆ—å¯æ»‘ã€é¡¯ç¤ºæ¸¸æ¨™ ===== */
    body.mode-elder .grid {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
      padding: 4px 2px;
    }

    /* æŠŠåŸæœ¬ä¹å®®çš„ 4 å€‹ç©ºç™½æ ¼éš±è— */
    body.mode-elder .grid>div:empty {
      display: none;
    }

    /* ä¸€åˆ—æ™‚æ¯é¡†å›ºå®šå°ºå¯¸ã€å¯å±…ä¸­å°é½Š */
    body.mode-elder .cell {
      flex: 0 0 auto;
      width: 140px;
      height: 140px;
      /* è¦†è“‹åŸæœ¬ aspect-ratio çš„å°ºå¯¸ï¼Œè¦–è¦ºæ›´ç©©å®š */
      scroll-snap-align: center;
    }

    /* æ¸¸æ¨™ï¼ˆæ­£åœ¨è¼¸å…¥ï¼‰ */
    .cell {
      position: relative;
      overflow: visible;
    }

    /* è®“æ¸¸æ¨™å¯å¤–å‡¸ */
    .cursor {
      position: absolute;
      top: -8px;
      right: 6px;
      background: #6495ED;
      color: #FFFFFF;
      font-weight: 800;
      font-size: 16px;
      padding: 4px 8px;
      border-radius: 8px;
      z-index: 5;
    }

    /* ä¸€åˆ—æ™‚å¼·åˆ¶æ’åºç‚º 1â†’2â†’3â†’4â†’5ï¼ˆé¿å…æ²¿ç”¨ä¹å®®åŸæœ¬ DOM é †åºï¼‰ */
    body.mode-elder #pos1 {
      order: 1;
    }

    body.mode-elder #pos2 {
      order: 2;
    }

    body.mode-elder #pos3 {
      order: 3;
    }

    body.mode-elder #pos4 {
      order: 4;
    }

    body.mode-elder #pos5 {
      order: 5;
    }


    /* ===== æ”¾å¤§æ¨¡å¼ï¼šæ£‹å­é¸æ“‡å€æ”¹ç‚º 2Ã—7 ç¶²æ ¼ï¼Œä¸”æ•´é«”å¯å·¦å³æ»‘å‹• ===== */
    body.mode-elder .picker-wrap {
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 6px 4px;
    }

    /* å…§å±¤ç”¨å›ºå®š 7 æ¬„çš„ç¶²æ ¼ï¼›å¯¬åº¦ç”¨å…§å®¹æ’é–‹ï¼Œè®“å¤–å±¤å¯ä»¥æ°´å¹³æ²å‹• */
    body.mode-elder .picker-grid {
      display: grid;
      grid-template-columns: repeat(7, auto);
      gap: 12px;
      width: max-content;
      /* é—œéµï¼šä»¥å…§å®¹å¯¬åº¦ç‚ºæº–ï¼Œè¶…éè¢å¹•å°±èƒ½æ©«å‘æ²å‹• */
    }

    /* æ”¾å¤§ç´„ 1.5 å€çš„æŒ‰éˆ•å°ºå¯¸èˆ‡å­—ç´šï¼ˆæ”¾å¤§æ¨¡å¼å°ˆç”¨ï¼Œä¸å½±éŸ¿ä¸€èˆ¬æ¨¡å¼ï¼‰ */
    body.mode-elder .piece-btn {
      min-width: 100px;
      /* åŸæœ¬ ~80 â†’ 120 */
      height: 100px;
      /* åŸæœ¬ ~48 â†’ 72 */
      font-size: 48px;
      /* åŸæœ¬ ~20 â†’ 32 */
      font-weight: 800;
      border: 3px solid #000;
      /* è¦–è¦ºæ›´æ¸…æ¥š */
      border-radius: 18px;
    }

    /* åˆ‡æ›æ¨¡å¼æŒ‰éˆ•ï¼ˆä¾é¡¯ç¤ºæ–‡å­—æ±ºå®šé…è‰²ï¼‰ */
    .mode-toggle {
      font-weight: 400;
      font-size: 18px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
    }

    /* é¡¯ç¤ºã€Œä¸€èˆ¬æ¨¡å¼ã€æ™‚ï¼šé»ƒåº•ã€è—å­—ï¼ˆæç¤ºæŒ‰ä¸‹æœƒå›åˆ°ä¸€èˆ¬ï¼‰ */
    #elderToggleBtn.mode-normal {
      background: #CCFF00;
      /* é»ƒ */
      color: #1D4ED8;
      /* è— */
      border-color: #CCFF00;
    }

    /* é¡¯ç¤ºã€Œæ”¾å¤§æ¨¡å¼ã€æ™‚ï¼šè—åº•ã€ç™½å­—ï¼ˆæç¤ºæŒ‰ä¸‹æœƒåˆ‡åˆ°é•·è¼©ï¼‰ */
    #elderToggleBtn.mode-elder {
      background: #2563EB;
      /* è— */
      color: #FFFFFF;
      /* ç™½ */
      border-color: #2563EB;
    }

    #elderToggleBtn:active {
      transform: translateY(1px);
    }

    /* ===== åˆ·æ–°æç¤ºæ¢ ===== */
    #refreshIndicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 0;
      line-height: 50px;
      background: #4caf50;
      color: black;
      font-weight: bold;
      font-size: 18px;
      text-align: center;
      overflow: hidden;
      transition: height 0.3s ease;
      z-index: 1000;
      user-select: none;
    }

    .off {
      opacity: .5;
    }

    /* âœ… åˆ†äº«é¢æ¿å…§çš„å”¯è®€æ£‹ç›¤ï¼ˆå°ä¸€è™Ÿã€ä¸å¯é»ï¼‰ */
    .share-board .grid {
      gap: 20px;
      margin: 4px 0 12px;
    }

    .share-board .cell {
      min-width: 56px;
      min-height: 56px;
      font-size: 28px;
      border-style: solid;
      cursor: default;
    }

    .share-board .cell.ro {
      pointer-events: none;
    }

    /* ç¦æ­¢æ“ä½œ */
    .share-board .poslabel {
      font-size: 12px;
      color: #aaa;
      margin-top: 2px;
    }

    /* ç¢ºä¿æ£‹å­æ ¼å­æ˜¯åœ“å½¢ï¼Œä¸¦å¯æ”¾å…§åœˆ */
    .share-board .cell {
      position: relative;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      /* è‹¥æƒ³æ›´ç©©å®šç­‰æ¯”ï¼š*/
      /* aspect-ratio: 1 / 1; */
    }

    .share-board .cell>* {
      position: relative;
      z-index: 1;
    }

    /* å…§å®¹åœ¨å…§åœˆä¹‹ä¸Š */

    /* æ£‹å­æ ¼å­çš„ç´…è‰²ï¼é»‘è‰²å¤–æ¡†ï¼ˆå¤–åœˆï¼‰ */
    .share-board .cell.red {
      border: 5px solid #d32f2f;
      color: #d32f2f;
      font-size: 48px;
      box-shadow: 0 0 4px rgba(211, 47, 47, 0.6);
    }

    .share-board .cell.black {
      border: 5px solid #111;
      color: #111;
      font-size: 48px;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
    }

    /* å…©å€‹å¯èª¿åƒæ•¸ï¼šå…§åœˆé›¢å¤–åœˆé–“è·ã€å…§åœˆç·šå¯¬ */
    .share-board {
      --inner-gap: 5px;
      --inner-width: 3px;
    }

    .share-board .cell.red::after,
    .share-board .cell.black::after {
      content: "";
      position: absolute;
      top: var(--inner-gap);
      right: var(--inner-gap);
      bottom: var(--inner-gap);
      left: var(--inner-gap);
      border: var(--inner-width) solid currentColor;
      /* âœ… åŒå¤–åœˆé¡è‰² */
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
      /* åœ¨å…§å®¹ä¸‹æ–¹ */
    }
	
	/* 4x8 æš—æ£‹é¢æ¿æ¨£å¼ */
.dark-grid{
  display:grid;
  grid-template-columns:repeat(4, minmax(64px,1fr));
  gap:12px;
  justify-items:center;
  align-items:center;
  padding:8px 4px;
}
.dark-cell{
flex-direction: column;
  width:60px; height:60px; border-radius:50%;
  border:4px solid #9ca3af; background:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:30px; line-height:1; user-select:none; cursor:pointer;
  position:relative; box-shadow:0 1px 2px rgba(0,0,0,.06) inset;
}
.dark-cell.face-down::after{
  content:""; position:absolute; inset:10px; border-radius:50%;
  border:2px dashed #c7ced6; background:#f3f4f6;
}
.dark-cell.flipped{ cursor:default; }
.dark-cell.red.flipped  { color:#d32f2f; border-color:#d32f2f; }
.dark-cell.black.flipped{ color:#111111; border-color:#111111; }
.dark-cell.disabled{ pointer-events:none; opacity:.6; }

/* å¯ä¾éœ€æ±‚å¾®èª¿å°ºå¯¸ */
@media (max-width: 380px){
  .dark-cell{ width:64px; height:64px; font-size:24px; }
}

/* æ£‹å­—æœ¬é«” */
.dark-cell .piece-text {
  font-size: 1em;           /* æ²¿ç”¨ .dark-cell çš„å­—é«”å¤§å°ï¼ˆ36px / æˆ–åª’é«”æŸ¥è©¢å¾Œçš„ 24pxï¼‰ */
  line-height: 1;
}

/* åºè™Ÿï¼ˆå°ä¸€é»ã€æ·¡ä¸€é»ï¼‰ï¼Œç½®æ–¼æ£‹å­—ä¸‹æ–¹ä¸€é» */
.dark-cell .flip-order {
  font-size: 14px;
  line-height: 1;
  margin-top: 4px;              /* â¬…ã€Œä¸‹é¢ä¸€é»ã€ */
  color: #666;
}
/* ä½¿ç”¨é€™ 5 é¡†ï¼šæœªé¸æ»¿æ™‚çš„è¦–è¦ºç‹€æ…‹ */
#btnUseSelected[disabled],
#btnUseSelected.is-disabled {
  opacity: .5;
  cursor: not-allowed;
  filter: grayscale(30%);
}

.card-title-input {
  font-size: 16px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 8px;
  width: 100%;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 32px 6px 32px; /* é ç•™å³é‚Šç©ºé–“çµ¦ icon */
  box-sizing: border-box;
}

.card-title-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
}

.clear-icon {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-63%);
  font-size: 42px;
  color: #aaa;
  cursor: pointer;
  display: none; /* é è¨­éš±è— */
}

.char-counter {
  font-size: 12px;
  color: #666;
  text-align: right;
  margin-top: 2px;
}
.char-counter.limit-reached {
  color: #d32f2f; /* è¶…éæ™‚è®Šç´…è‰² */
}

  </style>
</head>

<body>
  <div id="refreshIndicator">ä¸‹æ‹‰åˆ·æ–°</div>

  <div id="mainContent">
    <div class="wrap">
      <div class="topbar">
        <div class="title">å–®å¦</div>
        <div class="bar-actions">
		  <button class="btn btn-secondary" id="chessMatrixBtn">ç·šä¸ŠæŠ½å¦</button>
          <button class="mode-toggle" id="elderToggleBtn">æ”¾å¤§æ¨¡å¼</button>
        </div>
      </div>

      <div id="status" class="status">åˆå§‹åŒ–ä¸­â€¦</div>

      <div class="card">
		<div class="card-title-wrapper">
		  <span class="clear-icon" id="clearTitleBtn">&times;</span>
          <input id="cardTitleInput" class="card-title-input" type="text" placeholder="è¼¸å…¥å•é¡Œåç¨±" />
		</div>
		<div class="char-counter" id="titleCharCounter">0 / 0</div>

        <!-- ä¹å®®æ ¼ï¼ˆä¸Šï¼š4 / ä¸­ï¼š2 1 3 / ä¸‹ï¼š5ï¼‰ -->
        <div class="grid" aria-label="åå­—ä¹å®®æ ¼">
          <div></div>
          <div class="cell" id="pos4"><span>4</span>
            <div class="poslabel">â†‘ é»é¸ä»¥é–å®š</div>
          </div>
          <div></div>

          <div class="cell" id="pos2"><span>2</span>
            <div class="poslabel">â†</div>
          </div>
          <div class="cell" id="pos1"><span>1</span>
            <div class="poslabel">ä¸­å¿ƒ</div>
          </div>
          <div class="cell" id="pos3"><span>3</span>
            <div class="poslabel">â†’</div>
          </div>

          <div></div>
          <div class="cell" id="pos5"><span>5</span>
            <div class="poslabel">â†“</div>
          </div>
          <div></div>
        </div>

        <div class="controls">
          <button class="btn btn-secondary" id="randomBtn">éš¨æ©Ÿ</button>
          <button class="btn btn-primary" id="sendBtn">é€å‡º</button>
          <button class="btn btn-secondary" id="clearBtn">æ¸…é™¤</button>
        </div>

        <!-- æ£‹å­é¸æ“‡ï¼ˆé»‘åœ¨ä¸Šã€ç´…åœ¨ä¸‹ï¼‰ -->
        <div class="pieces">
          <div class="picker-wrap">
            <div class="picker-grid" id="pickerGrid" aria-label="æ£‹å­é¸æ“‡ï¼ˆ7Ã—2ï¼Œå¯å·¦å³æ»‘å‹•ï¼‰">
              <div class="row" style="margin-bottom:12px;margin-top:12px;">
                <!-- é»‘åœ‹ï¼šå°‡ å£« è±¡ è»Š é¦¬ åŒ… å’ -->
                <button class="piece-btn black" data-piece="å°‡">å°‡</button>
                <button class="piece-btn black" data-piece="å£«">å£«</button>
                <button class="piece-btn black" data-piece="è±¡">è±¡</button>
                <button class="piece-btn black" data-piece="è»Š">è»Š</button>
                <button class="piece-btn black" data-piece="é¦¬">é¦¬</button>
                <button class="piece-btn black" data-piece="åŒ…">åŒ…</button>
                <button class="piece-btn black" data-piece="å’">å’</button>

                <!-- ç´…åœ‹ï¼šå¸¥ ä»• ç›¸ ä¿¥ å‚Œ ç‚® å…µ -->
                <button class="piece-btn red" data-piece="å¸¥">å¸¥</button>
                <button class="piece-btn red" data-piece="ä»•">ä»•</button>
                <button class="piece-btn red" data-piece="ç›¸">ç›¸</button>
                <button class="piece-btn red" data-piece="ä¿¥">ä¿¥</button>
                <button class="piece-btn red" data-piece="å‚Œ">å‚Œ</button>
                <button class="piece-btn red" data-piece="ç‚®">ç‚®</button>
                <button class="piece-btn red" data-piece="å…µ">å…µ</button>
              </div>
              <div class="footer-pad"></div>
            </div>
          </div>
        </div>

        <div class="hint" style="text-align: left;">é»é¸ä¸Šæ–¹æ£‹å­ï¼Œç³»çµ±æœƒä¾åºæ”¾å…¥ï¼š1 â†’ 2 â†’ 3 â†’ 4 â†’ 5</div>
        <div class="hint" style="text-align: left;">é»é¸ã€ŒæŒ‡å®šä½ç½®ã€â†’ å†é»ä¸Šæ–¹æ£‹å­</div>
        <div class="hint-box" style="display: flex; justify-content: space-between; align-items: center;">
          <div id="draw-mode" class="hint-version" style="text-align: left;">
            è¼¸å…¥æ–¹å¼ï¼šæ‰‹å‹•
          </div>
          <div class="hint-version" id="ver" style="text-align: right;">
          </div>
        </div>

      </div>

      <div id="logOutput"
        style="white-space: pre-wrap; background:#f0f0f0; padding:10px; border:1px solid #ccc; height:150px; overflow-y:auto;">
      </div>
    </div>
  </div>
  <!-- ğŸ”„ åˆ†äº«æ¨¡å¼ä½ˆå±€ï¼ˆé è¨­éš±è—ï¼›?action=share æˆ– ?a=share æ™‚é¡¯ç¤ºï¼‰ -->
  <div id="shareContent" class="wrap hidden" aria-label="åˆ†äº«è¨­å®šå€">
    <div class="topbar">
      <div class="title">åˆ†äº«è¨­å®š</div>
      <div class="bar-actions">
        <span class="ver-badge">Share Panel</span>
      </div>
    </div>

    <div class="status">è¨­å®šè¦åˆ†äº«çš„å…§å®¹ï¼ŒæŒ‰ä¸‹ã€Œåˆ†äº«ã€é€å‡º</div>

    <div class="card" role="region" aria-label="é¸é …">
      <!-- âœ… å”¯è®€åå­—æ£‹ç›¤ï¼ˆé¡¯ç¤ºå‰›å‰›è¦åˆ†äº«çš„ 1-5 æ£‹å­ï¼‰ï¼Œä¸å¯æ“ä½œ -->
      <div id="shareBoard" class="share-board" aria-label="åˆ†äº«æ£‹ç›¤ï¼ˆå”¯è®€ï¼‰">
        <div class="grid">
          <div></div>
          <div class="cell ro" id="spos4"><span>4</span>
          </div>
          <div></div>
          <div class="cell ro" id="spos2"><span>2</span>
          </div>
          <div class="cell ro" id="spos1"><span>1</span>
          </div>
          <div class="cell ro" id="spos3"><span>3</span>
          </div>
          <div></div>
          <div class="cell ro" id="spos5"><span>5</span>
          </div>
          <div></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1.2fr 2fr;gap:8px;align-items:center;">
        <label>
          <input type="checkbox" id="chkTitle" checked />
          é¡¯ç¤ºå•é¡Œåç¨±
        </label>
        <div id="shareTitleText" class="ro-field"
          style="padding:10px;border:1px solid var(--border);border-radius:10px;background:#f9fafb;min-height:40px;display:flex;align-items:center;">
        </div>
        <label>
          <input type="checkbox" id="chkScore" checked />
          é¡¯ç¤ºç™‚ç™’åˆ†æ•¸
        </label>
        <div id="shareScoreText" class="ro-field"
          style="padding:10px;border:1px solid var(--border);border-radius:10px;background:#f9fafb;min-height:40px;display:flex;align-items:center;">
        </div>
      </div>
    </div>

    <div class="controls" style="margin-top:12px;display:flex;gap:8px;">
      <button class="btn btn-primary" id="btnShare">åˆ†äº«</button>
      <button class="btn btn-secondary" id="btnCancel">å–æ¶ˆ</button>
    </div>
  </div>

  </div>

  <script>
    /** ******************************
    *  ğŸ”§ åœ¨é€™è£¡æ›ä½ çš„ LIFF ID & ç‰ˆæœ¬
    *********************************/
    /** 2007906926-NZW6EQ7P Production **/
    /** 2007931033-4D50LqwM Dev **/
    const LIFF_ID = "2007931033-4D50LqwM";
    const APP_VERSION = "v1.0.3-44";
    const LINE_ID = "@968noswo"; // ä½ çš„å®˜æ–¹å¸³è™Ÿ IDï¼ˆ@ é–‹é ­ï¼‰

    /** ******************************
    *  ğŸ§° å…¨å¥— 32 æšç‰Œå †ï¼ˆæŠ½éå³ç§»é™¤ï¼‰
    *********************************/
    // ä»¥æ•´å‰¯æ£‹çš„æ•¸é‡å»ºç«‹å®Œæ•´ç‰Œå †
    const FULL_DECK_COUNTS = {
      "å¸¥": 1, "ä»•": 2, "ç›¸": 2, "ä¿¥": 2, "å‚Œ": 2, "ç‚®": 2, "å…µ": 5,
      "å°‡": 1, "å£«": 2, "è±¡": 2, "è»Š": 2, "é¦¬": 2, "åŒ…": 2, "å’": 5
    };
    // ä¾æ•¸é‡å±•é–‹æˆé™£åˆ—ï¼ˆ32 æšï¼‰
    function makeFullDeck() {
      const arr = [];
      Object.entries(FULL_DECK_COUNTS).forEach(([type, n]) => {
        for (let i = 0; i < n; i++) arr.push(type);
      });
      return arr;
    }
    // ç›®å‰ç‰Œå †ï¼ˆnull è¡¨ç¤ºå°šæœªå»ºç«‹æˆ–å·²é‡ç½®ï¼‰
    let deck = null;

    // éœ€æ±‚ï¼šç¬¬ä¸€æ¬¡æŒ‰ã€Œéš¨æ©Ÿã€æˆ–æ¸…ç©ºå¾Œæ‰å»ºç«‹ç‰Œå †
    function ensureDeck() {
      if (!deck || deck.length === 0) deck = makeFullDeck();
      return deck;
    }
    // å¾ç‰Œå †éš¨æ©ŸæŠ½ 1 æšï¼ˆæœƒç§»é™¤è©²æšï¼‰
    function drawFromDeck() {
      ensureDeck();
      if (deck.length === 0) return null;
      const idx = Math.floor(Math.random() * deck.length);
      const [picked] = deck.splice(idx, 1);
      return picked; // å›å‚³æ£‹ç¨®å­—å…ƒ
    }

    // è¼¸å…¥æ–¹å¼ï¼ˆæ‰‹å‹• / éš¨æ©Ÿï¼‰
    let drawMode = "æ‰‹å‹•"; // é è¨­æ‰‹å‹•
    function setDrawMode(mode) {
      drawMode = mode;
      const dm = document.getElementById("draw-mode");
      if (dm) dm.textContent = `è¼¸å…¥æ–¹å¼ï¼š${drawMode}`;
    }

    function getSwitchModeName() {
      return document.body.classList.contains('mode-elder') ? 'æ”¾å¤§æ¨¡å¼' : 'ä¸€èˆ¬æ¨¡å¼';
    }

    // è®€å¯«æ¨¡å¼
    function applyElderMode(on) {
      document.body.classList.toggle('mode-elder', !!on);
      localStorage.setItem('elderMode', on ? '1' : '0');
      const btn = document.getElementById('elderToggleBtn');
      if (btn) {
        btn.textContent = on ? 'ä¸€èˆ¬æ¨¡å¼' : 'æ”¾å¤§æ¨¡å¼';
        btn.classList.remove('mode-normal', 'mode-elder');
        btn.classList.add(on ? 'mode-normal' : 'mode-elder');
      }

      // æ–°å¢ï¼šåˆ‡æ› .hint å…ƒç´ æ–‡å­—å¤§å°
      const hints = document.querySelectorAll('.hint');
      hints.forEach(hint => {
        hint.classList.toggle('large', on);
      });

      // æ–°å¢ï¼šåˆ‡æ› .hint-version å…ƒç´ æ–‡å­—å¤§å°
      const hint_versions = document.querySelectorAll('.hint-version');
      hint_versions.forEach(hint => {
        hint.classList.toggle('large', on);
      });

      if (on) {
        const pos = selectedPos || firstEmptyPos();
        if (pos) {
          const el = document.getElementById('pos' + pos);
          if (el) el.scrollIntoView({
            behavior: 'smooth', inline: 'center', block: 'nearest'
          });
        }
      }
    }

    function initElderMode() {
      const saved = localStorage.getItem('elderMode') === '1';
      applyElderMode(saved);
    }

    // ä¸‹æ‹‰åˆ·æ–°åˆå§‹åŒ–
    let startY = 0;
    let isPulling = false;
    const refreshThreshold = 60; // ä¸‹æ‹‰å¤šå°‘è·é›¢è§¸ç™¼åˆ·æ–°
    const refreshElement = document.getElementById('refreshIndicator');

    window.addEventListener('touchstart', (e) => {
      if (window.scrollY === 0) {
        startY = e.touches[0].clientY;
        isPulling = true;
      }
    });

    window.addEventListener('touchmove', (e) => {
      if (!isPulling) return;
      let currentY = e.touches.clientY;
      let diff = currentY - startY;
      if (diff > 0) {
        refreshElement.style.height = diff + 'px';
        if (diff > refreshThreshold) {
          refreshElement.textContent = 'é‡‹æ”¾åˆ·æ–°';
        } else {
          refreshElement.textContent = 'ä¸‹æ‹‰åˆ·æ–°';
        }
      }
    });

    window.addEventListener('touchend', (e) => {
      if (!isPulling) return;
      let endY = e.changedTouches[0].clientY;
      let diff = endY - startY;
      if (diff > refreshThreshold) {
        refreshElement.textContent = 'æ­£åœ¨åˆ·æ–°...';
        doRefresh().then(() => {
          refreshElement.style.height = '0px';
          isPulling = false;
        });
      } else {
        refreshElement.style.height = '0px';
        isPulling = false;
      }
    });

    function doRefresh() {
      return new Promise((resolve) => {
        hardReload()
      });
    }

    // ====== ç‹€æ…‹èˆ‡å·¥å…· ======
    const $ = (id) => document.getElementById(id);
    const posEls = { 1: $("pos1"), 2: $("pos2"), 3: $("pos3"), 4: $("pos4"), 5: $("pos5") };
    const statusEl = $("status");

    // ç›®å‰ 5 æ ¼å…§å®¹ï¼š{ type, color } æˆ– null
    const picks = { 1: null, 2: null, 3: null, 4: null, 5: null };
    let selectedPos = null; // å®šä½æ¨¡å¼ï¼šä½¿ç”¨è€…é¸çš„ç›®æ¨™ä½ç½®

    const RED_SET = new Set(["å¸¥", "ä»•", "ç›¸", "ä¿¥", "å‚Œ", "ç‚®", "å…µ"]);
    const BLACK_SET = new Set(["å°‡", "å£«", "è±¡", "è»Š", "é¦¬", "åŒ…", "å’"]);

    // æ•´å‰¯æ£‹ä¸Šé™
    const PIECE_LIMITS = {
      "å¸¥": 1, "ä»•": 2, "ç›¸": 2, "ä¿¥": 2, "å‚Œ": 2, "ç‚®": 2, "å…µ": 5,
      "å°‡": 1, "å£«": 2, "è±¡": 2, "è»Š": 2, "é¦¬": 2, "åŒ…": 2, "å’": 5
    };

    function pieceColorOf(type) {
      if (RED_SET.has(type)) return "red";
      if (BLACK_SET.has(type)) return "black";
      return null;
    }
    function firstEmptyPos() {
      for (let i = 1; i <= 5; i++) if (!picks[i]) return i;
      return null;
    }
    function countUsed(type) {
      let c = 0;
      for (let i = 1; i <= 5; i++) if (picks[i]?.type === type) c++;
      return c;
    }
    function canPlace(type, pos) {
      const limit = PIECE_LIMITS[type] ?? 0;
      const used = countUsed(type);
      const currentTypeAtPos = picks[pos]?.type || null;
      if (currentTypeAtPos === type) return true; // è¦†è“‹åŒç¨®ä¸å¢åŠ ç”¨é‡
      return used < limit;
    }

    function render() {
      const cursorPos = selectedPos || firstEmptyPos(); // æ²’é–å®šå°±é¡¯ç¤ºä¸‹ä¸€ç©ºä½

      for (let i = 1; i <= 5; i++) {
        const el = posEls[i];
        el.classList.remove("red", "black", "selected");

        if (picks[i]) {
          el.innerHTML = `<span>${picks[i].type}<\/span><div class="poslabel">${i}<\/div>`;
          el.classList.add(picks[i].color === "red" ? "red" : "black");
        } else {
          const dir = i === 1 ? "ä¸­å¿ƒ" : i === 2 ? "ä½ç½®" : i === 3 ? "ä½ç½®" : i === 4 ? "ä½ç½®" : "ä½ç½®";
          el.innerHTML = `<span>${i}<\/span><div class="poslabel">${dir}<\/div>`;
        }
        if (selectedPos === i) el.classList.add("selected");

        // å…ˆæ¸…èˆŠæ¸¸æ¨™ï¼Œå†è¦–éœ€è¦åŠ ä¸Š
        el.querySelectorAll('.cursor').forEach(n => n.remove());
        if (cursorPos === i) {
          const tag = document.createElement('div');
          tag.className = 'cursor';
          tag.textContent = 'æ­£åœ¨è¼¸å…¥';
          el.appendChild(tag);
        }
      }

      // è€äººæ¨¡å¼ï¼šæŠŠæ¸¸æ¨™é‚£æ ¼æ²åˆ°å¯è¦–ç¯„åœ
      if (document.body.classList.contains('mode-elder') && cursorPos) {
        const el = document.getElementById('pos' + cursorPos);
        if (el) el.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }

    function setSelected(pos) {
      selectedPos = (selectedPos === pos ? null : pos);
      render();
    }

    function addPiece(type) {
      setDrawMode("æ‰‹å‹•"); // â† ä½¿ç”¨è€…é»åº•éƒ¨æ£‹å­è¦–ç‚ºæ‰‹å‹•
      const color = pieceColorOf(type);
      if (!color) return;

      const pos = selectedPos || firstEmptyPos();
      if (!pos) { alert("å·²æ”¾æ»¿ 5 æ ¼ï¼›è‹¥è¦é‡é¸ï¼Œè«‹æŒ‰ã€Œæ¸…é™¤ã€ã€‚"); return; }

      if (!canPlace(type, pos)) {
        const remain = (PIECE_LIMITS[type] - countUsed(type));
        alert(`ã€Œ${type}ã€å¯ç”¨æ•¸é‡ä¸è¶³ï¼ˆå‰©é¤˜ ${Math.max(0, remain)}ï¼‰`);
        return;
      }

      picks[pos] = { type, color };
      const next = firstEmptyPos();
      selectedPos = next; // è‹¥æ»¿æ ¼æœƒæ˜¯ null
      render();
    }

    function createPiece(type) {
      const color = pieceColorOf(type);
      if (!color) return;
      return { type, color };
    }

    function clearAll(resetMode = true, resetDeck = true) {
      for (let i = 1; i <= 5; i++) picks[i] = null;
      selectedPos = null;
      if (resetMode) setDrawMode("æ‰‹å‹•"); // æ¸…ç©ºå¾Œå›åˆ°æ‰‹å‹•ï¼ˆå¯é—œé–‰ï¼‰
      if (resetDeck) deck = null;        // â˜… æ¸…ç©ºæ™‚ä¹Ÿé‡ç½®ç‰Œå †ï¼ˆå›åˆ° 32 æšï¼‰
      render();
    }

    function hardReload() {
      const base = location.origin + location.pathname;
      location.replace(base + "?t=" + Date.now()); // ç ´å¿«å–
    }

    // ====== éš¨æ©Ÿ 5 é¡†ï¼ˆéµå®ˆæ¯ç¨®ä¸Šé™ï¼‰ ======
    function randomFillAll() {
      // å…ˆæ¸…ç©ºäº”æ ¼ï¼†é‡ç½®ç‰Œå †ï¼ˆä¿ç•™ã€Œéš¨æ©Ÿã€æ¨¡å¼ï¼‰
      clearAll(false, true);
      setDrawMode("éš¨æ©Ÿ");

      // ç¢ºä¿æœ‰ 32 æšå®Œæ•´ç‰Œå †
      ensureDeck();

      const order = [1, 2, 3, 4, 5];
      for (const pos of order) {
        const type = drawFromDeck();
        if (!type) { alert("ç‰Œå †æ„å¤–ç‚ºç©ºï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚"); ensureDeck(); break; }
        // deck å·²ä¿è­‰æ•¸é‡ï¼Œç†è«–ä¸Šä¸æœƒè¶…ä¸Šé™ï¼›ä¿éšªæª¢æŸ¥å¯ä¿ç•™
        if (!canPlace(type, pos)) continue;
        picks[pos] = { type, color: pieceColorOf(type) };
      }

      selectedPos = null; // æŠ½æ»¿å¾Œå–æ¶ˆé–å®š
      render();
    }


    // ====== éš¨æ©ŸæŠ½ 1 æšï¼ˆè‹¥ 5 æ ¼å·²æ»¿å‰‡æç¤ºï¼‰ ======
    function randomDrawOne() {
      // è‹¥ 5 æ ¼å·²æ»¿ï¼Œç›´æ¥æç¤º
      const empty = firstEmptyPos();
      if (!empty) { alert("5 æ ¼å·²æ»¿ï¼Œè«‹å…ˆã€Œæ¸…é™¤ã€å†æŠ½ã€‚"); return; }

      // å®šä½æ¨¡å¼å„ªå…ˆï¼šè‹¥é–å®šçš„æ ¼ç‚ºç©ºï¼Œå°±æ”¾é‚£æ ¼ï¼›å¦å‰‡æ”¾æœ€å‰é¢ç©ºæ ¼
      const target = (selectedPos && !picks[selectedPos]) ? selectedPos : empty;

      // æŠ½ 1 æšï¼›è‹¥ç‰Œå †ç©ºäº†æœƒè‡ªå‹•é‡å»º
      setDrawMode("éš¨æ©Ÿ");
      const type = drawFromDeck();
      if (!type) { alert("ç‰Œå †å·²ç©ºï¼Œå·²é‡å»ºã€‚è«‹å†è©¦ä¸€æ¬¡ã€‚"); ensureDeck(); return; }

      // æ”¾åˆ°ç›®æ¨™æ ¼
      if (!canPlace(type, target)) {
        // ç†è«–ä¸Šä¸æœƒç™¼ç”Ÿï¼ˆå› ç‚º 5 æ ¼ä¸Šé™é å°æ–¼æ•´å‰¯æ£‹æ•¸ï¼‰ï¼Œä½†ä¿éšªè™•ç†ï¼š
        alert(`ã€Œ${type}ã€å·²è¶…å‡ºå¯ç”¨æ•¸é‡ï¼Œæ”¹æŠ½ä¸‹ä¸€æšã€‚`);
        return randomDrawOne(); // ç›´æ¥å†æŠ½ä¸€æš
      }
      picks[target] = { type, color: pieceColorOf(type) };

      // ä¸‹ä¸€å€‹é é¸ç›®æ¨™ = ä¸‹ä¸€å€‹ç©ºæ ¼ï¼ˆè‹¥å·²æ»¿å‰‡ nullï¼‰
      selectedPos = firstEmptyPos();
      render();
    }

    function buildImageMessage() {
      const cells = [1, 2, 3, 4, 5].map(i => picks[i]);
      if (cells.some(x => !x)) { alert("è«‹å…ˆé¸æ»¿ 5 æ ¼å†é€å‡ºã€‚"); return null; }

      const toText = (cell) => ({
        type: "text",
        text: String(cell.type),
        weight: "bold",
        align: "center",
        size: "xl",
        color: cell.color === "red" ? "#d32f2f" : "#111111"
      });

      const t1 = toText(picks[4]);
      const t2 = toText(picks[2]);
      const t3 = toText(picks[1]);
      const t4 = toText(picks[3]);
      const t5 = toText(picks[5]);

      const summary = [1, 2, 3, 4, 5].map(i => `${i}:${picks[i].type}`).join("  ");
      const fiveStr = [1, 2, 3, 4, 5].map(i => picks[i].type).join(""); // äº”å­—
      const fiveParam = encodeURIComponent(fiveStr);
      const titleText = getCardTitle();
      const titleParam = encodeURIComponent(titleText);
      const modeTag = (drawMode === "éš¨æ©Ÿ" ? "éš¨æ©Ÿ" : "æ‰‹å‹•"); // è¦é¡¯ç¤ºçš„æ–‡å­—
      const modeParam = encodeURIComponent(modeTag);
      const modeHint = (drawMode === "éš¨æ©Ÿ" ? "*éš¨æ©ŸæŠ½å¦çµæœåƒ…ä¾›åƒè€ƒ*" : "");
      const auto = (drawMode === "éš¨æ©Ÿ") ? 1 : 0;
      const isBigMode = getSwitchModeName() === "æ”¾å¤§æ¨¡å¼" ? 1 : 0;

      return {
        type: 'image',
        originalContentUrl: `https://i.imgur.com/MwS42AE.png?p=5cg&c=${fiveStr}&n=${titleText}&at=${auto}&bg=${isBigMode}&v=${APP_VERSION}`,
        previewImageUrl: `https://i.imgur.com/MwS42AE.png`
      };
    }

    // ====== Flex é€å‡º ======
    function buildFlexMessage(urlParams, showTitle, showScore) {
      // å–å¾—ç¶²å€åƒæ•¸
      const action = urlParams.get('a'); // å–å¾— action åƒæ•¸ share
      const parameter = urlParams.get('p'); // å–å¾— parameter åƒæ•¸ 5cg
      const chessText = urlParams.get('c'); // å–å¾— 5 chess text åƒæ•¸
      const titleName = urlParams.get('n'); // å–å¾— name (title) åƒæ•¸
      const cVersion = urlParams.get('v'); // å–å¾— version åƒæ•¸
      const createTime = urlParams.get('tm'); // å–å¾— create time åƒæ•¸
      const auto = urlParams.get('at'); // å–å¾— æ˜¯å¦ç‚º auto åƒæ•¸
      const baseScore = urlParams.get('bs'); // å–å¾— base score åƒæ•¸
      const penaltyScroe = urlParams.get('ps'); // å–å¾— penalty score åƒæ•¸
      const mFace = urlParams.get('f'); // å–å¾— emoji face

      if (parameter === null) {
        document.body.insertAdjacentHTML('beforeend', '<p>æ²’æœ‰æ”¶åˆ° parameter åƒæ•¸</p>');
        return null;
      }

      if (parameter !== '5cg') {
        document.body.insertAdjacentHTML('beforeend', '<p>parameter åƒæ•¸éŒ¯èª¤</p>');
        return null;
      }

      if (chessText === null) {
        document.body.insertAdjacentHTML('beforeend', '<p>æ²’æœ‰æ”¶åˆ° chessText åƒæ•¸</p>');
        return null;
      }

      if (chessText.length !== 5) {
        document.body.insertAdjacentHTML('beforeend', '<p>chessText åƒæ•¸é•·åº¦éŒ¯èª¤</p>');
        return null;
      }


      if (baseScore === null || penaltyScroe === null) {
        document.body.insertAdjacentHTML('beforeend', '<p>æ²’æœ‰æ”¶åˆ° baseScore æˆ– penaltyScroe åƒæ•¸</p>');
        return null;
      }

      let finalScore = 0;
      let finalScoreText = ""
      let finalScoreDetail = ""
      let mEmoji = ''
      // åŸºæœ¬åˆ†æ•¸ å°æ–¼ 60 åˆ†ç‚º éœ€èª¿æ•´
      if (baseScore < 60) {
        mEmoji = 'ğŸ˜'
        finalScoreText = "éœ€èª¿æ•´";
        finalScoreDetail = ""
      } else {
        finalScore = baseScore - penaltyScroe; // è¨ˆç®— final score
        if (penaltyScroe > 0) {
          finalScoreDetail = `${baseScore}-${penaltyScroe}`; // final score è©³ç´°è¨ˆç®—
        }
        finalScoreText = `${finalScore}åˆ†`;
      }

      // å°‡åˆ†æ•¸æ›éœ²åˆ°å…¨åŸŸï¼Œåˆ†äº«é¢æ¿å¯è‡ªå‹•å¸¶å…¥
      window.latestHealingScore = finalScoreText;

      for (let i = 0; i < 5; i++) {
        let nextI = i + 1;
        picks[nextI] = createPiece(chessText.charAt(i));
      }

      const cells = [1, 2, 3, 4, 5].map(i => picks[i]);
      if (cells.some(x => !x)) { alert("è«‹å…ˆé¸æ»¿ 5 æ ¼å†é€å‡ºã€‚"); return null; }

      const toText = (cell) => ({
        type: "text",
        text: String(cell.type),
        weight: "bold",
        align: "center",
        size: "xl",
        color: cell.color === "red" ? "#d32f2f" : "#111111"
      });

      const t1 = toText(picks[4]);
      const t2 = toText(picks[2]);
      const t3 = toText(picks[1]);
      const t4 = toText(picks[3]);
      const t5 = toText(picks[5]);

      const summary = [1, 2, 3, 4, 5].map(i => `${i}:${picks[i].type}`).join("  ");
      const fiveStr = [1, 2, 3, 4, 5].map(i => picks[i].type).join(""); // äº”å­—
      const fiveParam = encodeURIComponent(fiveStr);
      const titleText = (titleName || "è±¡æ£‹åœå¦-å–®æ›").trim();
      const titleParam = encodeURIComponent(titleText);
      const modeHint = (auto === "1" ? "*éš¨æ©ŸæŠ½å¦çµæœåƒ…ä¾›åƒè€ƒ*" : "");
      const modeHintParam = encodeURIComponent(auto === "1" ? "*éš¨æ©ŸæŠ½å¦çµæœåƒ…ä¾›åƒè€ƒ*" : "");

      // â˜… åœ“åœˆå°ºå¯¸ï¼ˆå¯èª¿ï¼‰ï¼šå»ºè­° 72~90px
      const CIRCLE_SIZE = "80px";
      // â˜… æ–‡å­—å¤§å°ï¼ˆå¯èª¿ï¼‰ï¼š xxs / xs / sm / md / lg / xl / xxl / 3xl / 4xl / 5xl
      const PIECE_TEXT_SIZE = "4xl";
      // â˜… èˆ’æœèƒŒæ™¯è‰²ï¼ˆFlex bubble çš„ bodyï¼‰
      const FLEX_BG = "#F6F7FB"; // å¾®è—ç°ï¼Œè€çœ‹

      // å»ºè­°å›ºå®šåœˆåšåº¦ï¼Œç¶­æŒæ¯”ä¾‹
      const OUTER_RING_PX = 4;  // æœ€å¤–åœˆç²—åº¦
      const GAP_PX = 2;  // å…©åœˆé–“è·
      const INNER_RING_PX = 2;  // å…§åœˆç²—åº¦

      const toCircle = (cell) => {
        const pieceColor = cell.color === "red" ? "#d32f2f" : "#111111";
        const GAP_BG = typeof FLEX_BG === "string" ? FLEX_BG : "#F6F7FB"; // é–“éš”é¡è‰²ï¼å¡ç‰‡èƒŒæ™¯è‰²

        return {
          type: "box",
          layout: "vertical",
          width: CIRCLE_SIZE,
          height: CIRCLE_SIZE,
          cornerRadius: "999px",
          backgroundColor: pieceColor,                 // â˜… å¤–åœˆé¡è‰²ï¼ˆåŒå­—è‰²ï¼‰
          paddingAll: OUTER_RING_PX + "px",            // â˜… å¤–åœˆç²—åº¦
          contents: [
            {
              type: "box",
              layout: "vertical",
              width: "100%",
              height: "100%",
              cornerRadius: "999px",
              backgroundColor: GAP_BG,                 // â˜… å…©åœˆé–“éš”ï¼ˆç”¨å¡ç‰‡åº•è‰²è£½é€ ç¸«ï¼‰
              paddingAll: GAP_PX + "px",               // â˜… é–“éš”åšåº¦
              contents: [
                {
                  type: "box",
                  layout: "vertical",
                  width: "100%",
                  height: "100%",
                  cornerRadius: "999px",
                  backgroundColor: pieceColor,         // â˜… å…§åœˆé¡è‰²ï¼ˆåŒå­—è‰²ï¼‰
                  paddingAll: INNER_RING_PX + "px",    // â˜… å…§åœˆç²—åº¦
                  contents: [
                    {
                      type: "box",
                      layout: "vertical",
                      width: "100%",
                      height: "100%",
                      cornerRadius: "999px",
                      backgroundColor: "#FFFFFF",      // â˜… æ£‹é¢åº•è‰²ï¼ˆç™½åº•ï¼‰
                      contents: [
                        { type: "filler" },
                        {
                          type: "text",
                          text: String(cell.type),
                          weight: "bold",
                          align: "center",
                          size: PIECE_TEXT_SIZE,
                          color: pieceColor            // â˜… å­—è‰²èˆ‡åœ“åœˆåŒè‰²
                        },
                        { type: "filler" }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        };
      };

      const circ4 = toCircle(picks[4]);
      const circ2 = toCircle(picks[2]);
      const circ1 = toCircle(picks[1]);
      const circ3 = toCircle(picks[3]);
      const circ5 = toCircle(picks[5]);

      const contents = [];

      // 1) æ¨™é¡Œ
      if (showTitle) {
        contents.push({ type: "text", text: titleText, weight: "bold", size: "lg", wrap: true });
      }

      // 2) ç›¤é¢
      contents.push(
        { type: "box", layout: "horizontal", justifyContent: "center", contents: [circ4] },
        { type: "box", layout: "horizontal", spacing: "md", justifyContent: "center", contents: [circ2, circ1, circ3] },
        { type: "box", layout: "horizontal", justifyContent: "center", contents: [circ5] },
        { type: "separator", margin: "md" },
        {
          type: "box",
          layout: "vertical",
          spacing: "sm",
          contents: [{
            type: "box",
            layout: "horizontal",
            spacing: "md",
            contents: [
              { type: "text", text: createTime, size: "xs", color: "#9ca3af", align: "start" },
              { type: "text", text: cVersion, size: "xs", color: "#9ca3af", align: "end" }
            ]
          }]
        },
        { type: "text", text: summary, size: "sm", color: "#6b7280", wrap: true },
        { type: "text", text: modeHint, size: "sm", color: "#6b7280", wrap: true }
      );

      // 3) åˆ†æ•¸åˆ—
      if (showScore) {
        contents.push({
          type: "box",
          layout: "horizontal",
          spacing: "md",
          contents: [
            { type: "text", text: `ç™‚ç™’æˆæ•ˆï¼š${mFace}`, size: "lg", color: "#111111", gravity: "center", wrap: true, flex: 1, align: "start" },
            { type: "text", text: finalScoreText, size: "xxl", color: "#111111", gravity: "center", wrap: true, flex: 1, align: "end" }
          ]
        });

        if (finalScoreDetail !== "") {
          // è‹¥è¦ä¸€èµ·é¡¯ç¤º/éš±è—åˆ†æ•¸æ˜ç´°
          contents.push({ type: "text", text: finalScoreDetail, size: "sm", color: "#111111", align: "end" });
        }
      }

      // 4) çµ„å› body
      const bodyContents = {
        type: "box",
        layout: "vertical",
        spacing: "md",
        contents: contents
      };

      let sendTitle = ""
      if (showTitle) {
        sendTitle = `${titleText} ${summary}`
      } else {
        sendTitle = `${summary}`
      }

      return {
        type: "flex",
        altText: `${sendTitle}`,
        contents: {
          type: "bubble",
          styles: { // â˜… è¨­å®šæŸ”å’Œçš„èƒŒæ™¯è‰²
            body: { backgroundColor: FLEX_BG },
            footer: { backgroundColor: FLEX_BG }
          },
          body: bodyContents,
          footer: {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              { type: "text", text: "@968noswo Generated.", size: "xxs", color: "#9ca3af", align: "end" },
              { type: "text", text: " ", size: "xxs" },
              { type: "text", text: "è©¦è©¦ç™‚ç™’è±¡å¦AIç®—åˆ†?", weight: "bold", size: "md", color: "#4169E1", align: "center" },
              {
                type: "button",
                style: "primary",
                action: {
                  type: "uri",
                  label: "å‰å¾€",
                  uri: "line://ti/p/@968noswo"
                }
              }
            ]
          }
        }
      };
    }

    async function sendResult() {
      const flex = buildImageMessage();
      if (!flex) return;
      try {
        if (liff?.isInClient?.()) {
          await liff.sendMessages([flex]);
          printLog("sendMessages æˆåŠŸ");
          liff.closeWindow();
        } else if (liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          liff.closeWindow();
        } else {
          alert("è«‹åœ¨ LINE å…§é–‹å•Ÿæ­¤ LIFF é é¢å†é€å‡ºã€‚");
        }
      } catch (e) {
        const msg = (e?.message || e || '').toString();
        if ((msg.includes('scope') || msg.includes('not in LIFF app scope')) && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("å°šæœªæˆæ¬Š chat_message.writeï¼Œå·²æ”¹ç”¨åˆ†äº«é€å‡º");
        } else {
          alert("sendMessages å¤±æ•—ï¼š" + msg);
        }
      }
    }

    // âœ… ä¾ä¸»ç•«é¢çš„ picksï¼Œå°‡æ£‹å­é¡¯ç¤ºåˆ°åˆ†äº«é¢æ¿çš„å”¯è®€æ£‹ç›¤
    function renderShareBoardFromPicks(chessText) {
      for (let i = 0; i < 5; i++) {
        let nextI = i + 1;
        picks[nextI] = createPiece(chessText.charAt(i));
      }
      const idMap = { 1: 'spos1', 2: 'spos2', 3: 'spos3', 4: 'spos4', 5: 'spos5' };
      for (let i = 1; i <= 5; i++) {
        const el = document.getElementById(idMap[i]);
        if (!el) continue;
        el.classList.remove('red', 'black');
        const span = el.querySelector('span');
        if (picks[i]) {
          span.textContent = picks[i].type;
          el.classList.add(picks[i].color === 'red' ? 'red' : 'black');
        } else {
          span.textContent = String(i); // æ²’é¸åˆ°å°±é¡¯ç¤ºä½ç½®åºè™Ÿ
        }
      }
    }

    // ====== æ—¥èªŒè¼¸å‡º ======
    function printLog(message) {
      const logDiv = document.getElementById('logOutput');
      if (logDiv) {
        logDiv.textContent += message + "\n";
        logDiv.scrollTop = logDiv.scrollHeight;  // è‡ªå‹•æ²åˆ°åº•éƒ¨
      }
    }
	
	
	const MAX_TITLE_LENGTH = 50; // âœ… é€™è£¡æ§åˆ¶æœ€å¤§å­—æ•¸

    // ====== ç¶å®š UI ======
    $("clearBtn").addEventListener("click", clearAll);
    $("randomBtn").addEventListener("click", randomFillAll);
    $("sendBtn").addEventListener("click", sendResult);
	const cardTitleInput = document.getElementById("cardTitleInput");
	const clearTitleBtn = document.getElementById("clearTitleBtn");
	const titleCharCounter = document.getElementById("titleCharCounter");
	
	// å¦‚æœé‚„è¦å­˜å–é€™å€‹æ¨™é¡Œï¼Œå¯ä»¥ç›´æ¥è®€ value
	function getCardTitle() {
	  return cardTitleInput.value.trim();
	}
	
	// åˆå§‹åŒ–å­—æ•¸æç¤º
	titleCharCounter.textContent = `0 / ${MAX_TITLE_LENGTH}`;
	
	cardTitleInput.setAttribute("maxlength", MAX_TITLE_LENGTH);
	
	cardTitleInput.addEventListener("input", () => {
	  // ç§»é™¤æ›è¡Œç¬¦è™Ÿï¼ˆé˜²æ­¢è²¼ä¸Šå¤šè¡Œï¼‰
	  cardTitleInput.value = cardTitleInput.value.replace(/[\r\n]+/g, "");

	  const length = cardTitleInput.value.length;

	  // é¡¯ç¤ºæ¸…é™¤æŒ‰éˆ•
	  clearTitleBtn.style.display = length ? "block" : "none";

	  // æ›´æ–°å­—æ•¸
	  titleCharCounter.textContent = `${length} / ${MAX_TITLE_LENGTH}`;
	  if (length >= MAX_TITLE_LENGTH) {
		titleCharCounter.classList.add("limit-reached");
	  } else {
		titleCharCounter.classList.remove("limit-reached");
	  }

	  // ä¿éšªï¼šå­—æ•¸è¶…éä¸Šé™ï¼Œè‡ªå‹•æˆªæ–·
	  if (length > MAX_TITLE_LENGTH) {
		cardTitleInput.value = cardTitleInput.value.slice(0, MAX_TITLE_LENGTH);
	  }
	});

	// é»æ“Šæ¸…é™¤ icon
	clearTitleBtn.addEventListener("click", () => {
	  cardTitleInput.value = "";
	  clearTitleBtn.style.display = "none";
	  titleCharCounter.textContent = `0 / ${MAX_TITLE_LENGTH}`;
	  titleCharCounter.classList.remove("limit-reached");
	  cardTitleInput.focus();
	});

    Object.entries(posEls).forEach(([idx, el]) => {
      el.addEventListener("click", () => setSelected(Number(idx)));
    });

    document.querySelectorAll(".piece-btn").forEach(btn => {
      btn.addEventListener("click", () => addPiece(btn.dataset.piece));
    });

    document.getElementById('elderToggleBtn').addEventListener('click', () => {
      const on = !document.body.classList.contains('mode-elder');
      applyElderMode(on);
    });

    let gUrlParams = null; // å„²å­˜ URL åƒæ•¸ç‰©ä»¶

    // âœ… æœ€å°å®ˆé–€å“¡ï¼šåªå…è¨±ã€Œæ‰‹æ©Ÿ LINE App å…§ã€æ‰“é–‹
    async function guardMobileLineOnly(_liffId) {
      try {
        // åªç‚ºäº†æ‹¿ isInClient / getOSï¼›ç¦ç”¨å¤–éƒ¨ç€è¦½å™¨è‡ªå‹•ç™»å…¥
        await liff.init({ liffId: _liffId, withLoginOnExternalBrowser: false });
      } catch (_) { /* é‡è¤‡ init ç„¡å¦¨ */ }

      const inClient = !!(window.liff && liff.isInClient());
      const os = window.liff ? liff.getOS() : 'web';  // 'ios' | 'android' | 'web'
      const isMobileLine = inClient && (os === 'ios' || os === 'android');

      if (!isMobileLine) {
        // å¼•å°å› LINEï¼ˆæœƒæŠŠç›®å‰çš„ querystring ä¸€èµ·å¸¶å›ï¼‰
        const deeplink = `line://app/${_liffId}${location.search || ''}`;

        // è‹¥é é¢æœ‰ä½ ä¹‹å‰åšçš„é®ç½©æŒ‰éˆ•ï¼Œé †æ‰‹æ›é€£çµé¡¯ç¤º
        const mask = document.getElementById('onlyInApp');
        const openBtn = document.getElementById('openInLine');
        if (openBtn) openBtn.href = deeplink;
        if (mask) mask.classList.remove('hidden');

        // ä¹Ÿå¯ç›´æ¥å˜—è©¦è·³è½‰
        try { location.href = deeplink; } catch (_) { }

        // è¨­ç½®æ——æ¨™ï¼Œè®“å…¶ä»–åˆå§‹åŒ–é‚è¼¯ä¸€å¾‹åœæ­¢
        window.__BLOCKED_OUT_OF_LINE__ = true;
        return false;
      }
      return true;
    }
	
    // ====== åˆå§‹åŒ– LIFF ======
    (async () => {
      try {
        statusEl.textContent = "é é¢åˆå§‹åŒ–ä¸­â€¦";

        // â˜… å…ˆåšã€Œåªèƒ½åœ¨æ‰‹æ©Ÿ LINEã€çš„ç’°å¢ƒæª¢æŸ¥
        const ok = await guardMobileLineOnly(LIFF_ID);
        if (!ok) {
          statusEl.textContent = "è«‹åœ¨æ‰‹æ©Ÿ LINE ä¸­é–‹å•Ÿæ­¤é é¢";
          return; // â˜… ç›´æ¥åœæ­¢ï¼Œä¸åšå¾ŒçºŒç™»å…¥/æ¸²æŸ“
        }

        // â˜… çœŸæ­£çš„åˆå§‹åŒ–ï¼ˆé—œæ‰å¤–éƒ¨ç€è¦½å™¨è‡ªå‹•ç™»å…¥ï¼‰
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: false });
        printLog("é é¢åˆå§‹åŒ–æˆåŠŸ");

        // â˜… é€™è£¡ä¸€å®šæ˜¯åœ¨ LINE App å…§äº†ï¼Œæ‰å…è¨±ç™»å…¥
        if (!liff.isLoggedIn()) {
          statusEl.textContent = "æœªç™»å…¥ â†’ å°å‘ç™»å…¥";
          await liff.login(); // æœƒè·³è½‰ï¼Œå¾Œé¢ä¸æœƒç¹¼çºŒ
          return;
        }

        // ç™»å…¥æˆåŠŸï¼Œå–å¾—ä½¿ç”¨è€…è³‡è¨Š
        const profile = await liff.getProfile();
        printLog("ç”¨æˆ¶åç¨±ï¼š" + profile.displayName);
        statusEl.textContent = `Hello, ${profile.displayName} ğŸ‘‹`;

        // å–å¾—ç¶²å€åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        gUrlParams = urlParams; // å„²å­˜èµ·ä¾†çµ¦å…¶ä»–å‡½å¼ç”¨
      } catch (err) {
        printLog("åˆå§‹åŒ–éŒ¯èª¤: " + (err?.message || err));
        statusEl.textContent = `LIFF åˆå§‹åŒ–å¤±æ•—ï¼š${err?.message || "unknown"}`;
      }
    })();

    // ====== åˆå§‹ç‹€æ…‹èˆ‡ç‰ˆæœ¬é¡¯ç¤º ======
    document.getElementById("ver").textContent = LINE_ID + " | " + APP_VERSION;

    // éš±è—æ—¥èªŒè¼¸å‡ºå€åŸŸ
    document.getElementById("logOutput").classList.add("hidden");

    initElderMode();
    // åˆæ¬¡æ¸²æŸ“
    render();

    // ===== åˆ†äº«æ¨¡å¼ï¼šåƒæ•¸è§£æèˆ‡ UI åˆ‡æ› =====
    (function setupShareModePanel() {
      const qs = new URLSearchParams(location.search);
      const action = qs.get('a');      // æ—¢æœ‰åƒæ•¸ï¼ša=share
      const parameter = qs.get('p'); //  å–å¾— parameter åƒæ•¸ 5cg
      const chessText = qs.get('c'); // æ–°åƒæ•¸ï¼šc=XXXXX äº”å­—
      const isShareMode = (action === 'share');

      // å…©å€‹å®¹å™¨ï¼šä¸»ç•«é¢ & åˆ†äº«ç•«é¢
      const mainEl = document.getElementById('mainContent');
      const shareEl = document.getElementById('shareContent');
      const refreshEl = document.getElementById('refreshIndicator');

      if (!isShareMode || !shareEl) {
        mainEl.classList.remove('hidden');
        return;
      }

      // éš±è—åŸæœ¬æ‰€æœ‰ç•«é¢å…ƒä»¶ï¼Œåªé¡¯ç¤ºåˆ†äº«é¢æ¿
      if (mainEl) mainEl.classList.add('hidden');
      if (refreshEl) refreshEl.classList.add('hidden');
      shareEl.classList.remove('hidden');

      // âœ… é¡¯ç¤ºå”¯è®€æ£‹ç›¤å…§å®¹
      renderShareBoardFromPicks(chessText);

      // ==== é è¨­å€¼ï¼šå¾ç¶²å€æˆ–ç›®å‰ç‹€æ…‹å¸¶å…¥ ====
      const chkTitle = document.getElementById('chkTitle');
      const chkScore = document.getElementById('chkScore');
      const inputTitle = document.getElementById('shareTitleText');
      const inputScore = document.getElementById('shareScoreText');
      const btnShare = document.getElementById('btnShare');
      const btnCancel = document.getElementById('btnCancel');

      // å…ˆå¸¶å…¥ï¼š?n=ï¼ˆèˆŠåƒæ•¸åç¨±ï¼‰æˆ– ?title=
      inputTitle.textContent = qs.get('n') || qs.get('title')
        || getCardTitle() || '';

      // æ¥ä¸Šç¾æœ‰åˆ†æ•¸é‚è¼¯ï¼š
      // 1) è‹¥ç¶²å€çµ¦äº† bs/psï¼ˆbase / penaltyï¼‰ï¼Œç…§æ—¢æœ‰è¦å‰‡æ¨ finalScoreText
      // 2) å¦å‰‡è®€å…¨åŸŸ window.latestHealingScore / window.healingScore
      // 3) éƒ½æ²’æœ‰å‰‡ç•™ç©ºï¼ˆå¯æ‰‹å‹•è¼¸å…¥ï¼‰
      (function fillScoreFromState() {
        const bs = qs.get('bs'), ps = qs.get('ps');
        if (bs !== null && ps !== null) {
          const base = Number(bs), pen = Number(ps);
          if (!isNaN(base) && !isNaN(pen)) {
            if (base < 60) {
              inputScore.textContent = 'éœ€èª¿æ•´';
            } else {
              inputScore.textContent = String(base - pen) + 'åˆ†';
            }
            return;
          }
        }
        if (typeof window.latestHealingScore !== 'undefined' && window.latestHealingScore !== null) {
          inputScore.textContent = String(window.latestHealingScore);
          return;
        }
        if (typeof window.healingScore !== 'undefined' && window.healingScore !== null) {
          inputScore.textContent = String(window.healingScore);
          return;
        }
      })();

      if (qs.has('showTitle')) chkTitle.checked = qs.get('showTitle') !== '0';
      if (qs.has('showScore')) chkScore.checked = qs.get('showScore') !== '0';

      let __liffReady = false;
      async function ensureLiff() {
        if (__liffReady) return;
        if (!window.liff) throw new Error('LIFF SDK æœªè¼‰å…¥');
        try { await liff.init({ liffId: LIFF_ID }); } catch (e) { }
        __liffReady = true;
      }

      async function doShare() {
        const flex = buildFlexMessage(gUrlParams, chkTitle.checked, chkScore.checked);
        if (!flex) return;
        try {
          if (liff.isApiAvailable('shareTargetPicker')) {
            await liff.shareTargetPicker([flex]);
            alert("åˆ†äº«æˆåŠŸï¼Œå¯æ–¼èŠå¤©è¦–çª—ä¸­æŸ¥çœ‹");
            liff.closeWindow();
          } else {
            alert("è«‹åœ¨ LINE å…§é–‹å•Ÿæ­¤ LIFF é é¢å†é€å‡ºã€‚");
          }
        } catch (e) {
          const msg = (e?.message || e || '').toString();
          if ((msg.includes('scope') || msg.includes('not in LIFF app scope')) && liff.isApiAvailable('shareTargetPicker')) {
            await liff.shareTargetPicker([flex]);
            alert("å°šæœªæˆæ¬Š chat_message.writeï¼Œå·²æ”¹ç”¨åˆ†äº«é€å‡º");
          } else {
            alert("sendMessages å¤±æ•—ï¼š" + msg);
          }
        }
      }

      btnShare?.addEventListener('click', doShare);
      btnCancel?.addEventListener('click', () => {
        try {
          if (window.liff && typeof liff.closeWindow === 'function') {
            liff.closeWindow(); // åœ¨ LINE App å…§ç›´æ¥é—œé–‰
            return;
          }
        } catch (_) { }
        // å¾Œå‚™æ–¹æ¡ˆï¼šé LINE App æˆ– closeWindow å¤±æ•—
        window.close();
        if (!document.hidden) { // å¤šæ•¸ç€è¦½å™¨ä¸å…è¨± window.close() é—œé–‰é script-opened è¦–çª—
          if (history.length > 1) history.back();
          else location.href = 'about:blank';
        }
      });
    })();

// ===== æš—æ£‹ 32 å­ï¼ˆå›ºå®šçŸ©é™£ï¼›å¯è‡ªè¡Œèª¿æ•´é †åºï¼‰=====
// 8 rows Ã— 4 columnsï¼Œæ¯æ ¼ { t: æ£‹å­å­—, color: 'red'|'black' }
const DARK_CHESS_32 = [
  [ {t:"å£«",c:"black"}, {t:"è±¡",c:"black"}, {t:"é¦¬",c:"black"}, {t:"è»Š",c:"black"} ],
  [ {t:"åŒ…",c:"black"}, {t:"å’",c:"black"}, {t:"å’",c:"black"}, {t:"å’",c:"black"} ],
  [ {t:"å’",c:"black"}, {t:"å’",c:"black"}, {t:"åŒ…",c:"black"}, {t:"å°‡",c:"black"} ],
  [ {t:"è±¡",c:"black"}, {t:"å£«",c:"black"}, {t:"è»Š",c:"black"}, {t:"é¦¬",c:"black"} ],

  [ {t:"ä»•",c:"red"},   {t:"ç›¸",c:"red"},   {t:"å‚Œ",c:"red"},   {t:"ä¿¥",c:"red"} ],
  [ {t:"ç‚®",c:"red"},   {t:"å…µ",c:"red"},   {t:"å…µ",c:"red"},   {t:"å…µ",c:"red"} ],
  [ {t:"å…µ",c:"red"},   {t:"å…µ",c:"red"},   {t:"ç‚®",c:"red"},   {t:"å¸¥",c:"red"} ],
  [ {t:"ç›¸",c:"red"},   {t:"ä»•",c:"red"},   {t:"ä¿¥",c:"red"},   {t:"å‚Œ",c:"red"} ],
];

// ===== ç‹€æ…‹ =====
let flipSelections = []; // ä½¿ç”¨è€…å·²ç¿»çš„ 5 é¡†ï¼ˆç…§é †åºï¼‰
const gridEl = () => document.getElementById('darkGrid');
const gridView = () => document.getElementById('randomGridView');
const mainView = () => document.getElementById('mainContent'); // ä½ çš„ä¸»ç•«é¢å®¹å™¨ id

// ç›®å‰æ£‹ç›¤å°æ‡‰çš„ 32 é¡†ï¼ˆæœ¬æ¬¡é¢æ¿ç”¨çš„éš¨æ©Ÿçµæœï¼‰
let shuffledPieces = [];

// Fisherâ€“Yates æ´—ç‰Œï¼šæŠŠ DARK_CHESS_32 æ”¤å¹³å¾Œæ‰“äº‚
function shuffleDeck() {
  const arr = [];
  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 4; c++) {
      arr.push(DARK_CHESS_32[r][c]); // { t, c }
    }
  }
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ===== å…¥å£ï¼šé–‹å•Ÿ 4x8 æ£‹ç›¤æµç¨‹ =====
function openRandomGrid(){
  flipSelections = [];
  setUseButtonState(0);        // â† æ–°å¢
  shuffledPieces = shuffleDeck();     // â† é€™æ¬¡é¢æ¿è¦ç”¨çš„éš¨æ©Ÿçµæœ
  
  // é¡¯ç¤º/éš±è—
  mainView()?.classList.add('hidden');
  gridView()?.classList.remove('hidden');
  // æ¸²æŸ“æ£‹ç›¤
  renderDarkGrid();
}

// ===== æ¸²æŸ“ 4x8 æ£‹ç›¤ï¼ˆå…¨éƒ¨æœä¸‹ï¼‰ =====
function renderDarkGrid(){
  const el = gridEl();
  if(!el) return;
  el.innerHTML = "";
  for(let r=0; r<8; r++){
    for(let c=0; c<4; c++){
      const idx = r * 4 + c;
      const p = shuffledPieces[idx] || DARK_CHESS_32[r][c]; // ä¿åº•
      const cell = document.createElement('div');
      cell.className = 'dark-cell face-down';
      cell.dataset.r = r;
      cell.dataset.c = c;
      cell.dataset.t = p.t;
      cell.dataset.color = p.c;
      cell.addEventListener('click', onCellClick);
      el.appendChild(cell);
    }
  }
  // æ§åˆ¶æŒ‰éˆ•åˆå§‹ç‹€æ…‹
  // document.getElementById('btnUseSelected')?.setAttribute('disabled','');
  setUseButtonState(0);
}

// ===== é»æ ¼å­ç¿»å­ï¼ˆæœ€å¤š 5 é¡†ï¼‰=====
function onCellClick(e){
  const cell = e.currentTarget;
  if(cell.classList.contains('flipped')) return;
  if(flipSelections.length >= 5) return;

  // ç¿»é–‹
  cell.classList.remove('face-down');
  cell.classList.add('flipped', cell.dataset.color);
  //cell.textContent = cell.dataset.t;
 const order = flipSelections.length + 1; // é€™æ˜¯ç¬¬å¹¾é¡†
 cell.innerHTML = `
   <div class="piece-text">${cell.dataset.t}</div>
   <div class="flip-order">${order}</div>
 `;
  // ç´€éŒ„
  flipSelections.push({
    t: cell.dataset.t,
    color: cell.dataset.color,
    r: Number(cell.dataset.r),
    c: Number(cell.dataset.c),
	order          // â† å¯ç•™è‘—å‚™æŸ¥ï¼ˆä¸å½±éŸ¿å¾ŒçºŒï¼‰
  });

  const n = flipSelections.length;
  setUseButtonState(n);

  // æ»¿ 5 é¡†ï¼šé–ä½å…¶ä»–æ ¼å­ + å•Ÿç”¨ã€Œä½¿ç”¨é€™ 5 é¡†ã€
  if(n >= 5){
    gridEl()?.querySelectorAll('.dark-cell:not(.flipped)')
      .forEach(node => node.classList.add('disabled'));
  }
}

// ===== å–æ¶ˆï¼šå›ä¸»ç•«é¢ã€æ¸…ç©ºç‹€æ…‹ =====
function cancelRandomGrid(){
  gridView()?.classList.add('hidden');
  mainView()?.classList.remove('hidden');
  flipSelections = [];
  setUseButtonState(0);
}

// âœ… ä½¿ç”¨é€™ 5 é¡†ï¼šé¤µå›ä¸»ç•«é¢çš„ picks[1..5]ï¼Œä¸¦å›ä¸»ç•«é¢
function useFiveAndBack() {
  if (flipSelections.length < 5) {
    alert('è«‹å…ˆç¿»æ»¿ 5 é¡†');
    return;
  }

  // ä½ çš„é é¢æœ‰é ‚å±¤ const picksï¼ˆä¸æ˜¯ window.picksï¼‰
  // é€™è£¡å„ªå…ˆå¯«å…¥ picksï¼›è‹¥ä¸å­˜åœ¨å†é€€å› window.picks
  const targetPicks =
    (typeof picks !== 'undefined' && picks) ||
    (window.picks ||= { 1: null, 2: null, 3: null, 4: null, 5: null });

  // ä¾é»æ“Šé †åºå¡é€² 1..5
  for (let i = 0; i < 5; i++) {
    const p = flipSelections[i]; // { t, color, r, c }
    targetPicks[i + 1] = { type: p.t, color: p.color };
  }

  // é‡æ–°æ¸²æŸ“ä¸»ç•«é¢
  try { if (typeof render === 'function') render(); } catch (_) {}

  // å›ä¸»ç•«é¢
  cancelRandomGrid();
}


// ===== æŠŠã€Œéš¨æ©Ÿã€æŒ‰éˆ•æ”¹æˆé–‹å•Ÿæ–°é¢æ¿ =====
// è‹¥ä½ çš„æŒ‰éˆ• id ä¸æ˜¯ btnRandomï¼Œè«‹æŠŠé¸æ“‡å™¨æ›æˆä½ å¯¦éš›çš„
const chessMatrixBtn = document.getElementById('chessMatrixBtn') 
                || document.querySelector('[data-action="random"]') 
                || document.querySelector('.btn-random');
chessMatrixBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openRandomGrid(); });

// âœ… äº‹ä»¶å§”æ´¾ï¼šå³ä½¿æŒ‰éˆ•æ˜¯ä¹‹å¾Œæ‰é¡¯ç¤ºï¼Œä¹Ÿèƒ½æ¥åˆ°é»æ“Š
document.addEventListener('click', function (e) {
  const t = e.target;
  if (!t) return;

  // å–æ¶ˆ
  const cancelBtn = t.closest?.('#btnCancelGrid');
  if (cancelBtn) {
    e.preventDefault();
    cancelRandomGrid();
    return;
  }

  // ä½¿ç”¨é€™ 5 é¡†ï¼ˆéœ€é disabledï¼‰
  const useBtn = t.closest?.('#btnUseSelected');
  if (useBtn) {
    e.preventDefault();
    if (!useBtn.hasAttribute('disabled') && !useBtn.disabled) {
      useFiveAndBack();
    }
  }
});

// ä¾ç›®å‰å·²ç¿»æ•¸é‡ï¼Œæ›´æ–°ã€Œä½¿ç”¨é€™ 5 é¡†ã€æŒ‰éˆ•ç‹€æ…‹èˆ‡æ–‡å­—
function setUseButtonState(count) {
  const btn = document.getElementById('btnUseSelected');
  if (!btn) return;
  const enable = count >= 5;

  // å¯¦éš›å¯é»èˆ‡å±¬æ€§
  btn.disabled = !enable;
  if (enable) {
    btn.removeAttribute('disabled');
    btn.classList.remove('is-disabled');
    btn.textContent = 'ç¢ºèª';
  } else {
    btn.setAttribute('disabled', '');
    btn.classList.add('is-disabled');
    // é¡¯ç¤ºç›®å‰å·²ç¿»å¹¾é¡†ï¼ˆå¯æ”¹æˆä¸è¦é¡¯ç¤ºï¼‰
    btn.textContent = `å·²ç¿» ${count}ï¼5 é¡†`;
  }
}

</script>

  <div id="onlyInApp" class="wrap hidden"
    style="position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;text-align:center;padding:24px;">
    <div class="card" style="max-width:520px;">
      <div class="card-title">è«‹åœ¨ã€Œæ‰‹æ©Ÿ LINEã€ä¸­é–‹å•Ÿ</div>
      <p class="status">æœ¬æœå‹™åƒ…æ”¯æ´åœ¨ LINE App å…§é–‹å•Ÿã€‚é»æ“Šä¸‹æ–¹æŒ‰éˆ•å›åˆ° LINEã€‚</p>
      <div style="margin-top:12px">
        <a id="openInLine" class="btn btn-primary" href="#">åœ¨ LINE é–‹å•Ÿ</a>
      </div>
    </div>
  </div>

<!-- éš¨æ©Ÿç¿»å­é¢æ¿ï¼š4x8 æ£‹ç›¤ï¼ˆé è¨­éš±è—ï¼‰ -->
<div id="randomGridView" class="wrap hidden" aria-label="éš¨æ©Ÿç¿» 5 é¡†">
  <div class="topbar">
    <div class="bar-actions"></div>
  </div>
  
  <div class="controls" style="margin-top:8px;">
    <button class="btn btn-secondary" id="btnCancelGrid">å–æ¶ˆ</button>
    <button class="btn btn-primary" id="btnUseSelected" disabled>ç¢ºèª</button>
  </div>
  
  <div class="card">
    <div id="darkGrid" class="dark-grid"></div>
  </div>
</div>

</body>

</html>